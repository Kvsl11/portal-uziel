<!DOCTYPE html>
<html lang="pt-BR" class=""> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal do Ministério Uziel</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#29aae2"/>
    
    <meta name="description" content="Portal interno para membros do Ministério Uziel. Acesse links, documentos e ferramentas importantes.">

    <link rel="icon" href="3.png" type="image/png">

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Anton&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>


    <script>
        // Tailwind configuration
        tailwind.config = {
            darkMode: 'class', // Habilitando o modo escuro baseado em classe
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Poppins', 'sans-serif'],
                        'anton': ['Anton', 'sans-serif'],
                    },
                    colors: {
                        'brand': {
                            'blue': '#29aae2',
                            'dark-blue': '#2397cf',
                            'text': '#334155',
                            'light-gray': '#f1f5f9',
                            'background': '#f8fafc'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        html { scroll-behavior: smooth; }
        #portal { scroll-margin-top: 8rem; }
        #verse { scroll-margin-top: 8rem; }

        body { display: flex; flex-direction: column; min-height: 100vh; }
        main { flex-grow: 1; }
        #header { transition: padding 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease; }
        .header-scrolled {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .header-scrolled h1 { font-size: 1.5rem; }

        #home {
            background-image: url('4.jpg');
            background-size: cover;
            background-position: center;
            position: relative;
        }
        #verse {
            background-image: url('6.png');
            background-size: cover;
            background-position: center;
            position: relative;
        }
        .overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); z-index: 1; }
        .content-wrapper { position: relative; z-index: 2; }

        .portal-card-wrapper { transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1), width 0.5s ease-out, padding 0.5s ease-out, margin 0.5s ease-out; width: 100%; }
        .portal-card { transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .portal-card:hover { transform: translateY(-8px); box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.08), 0 8px 10px -6px rgb(0 0 0 / 0.08); }
        .portal-card-wrapper.filtered-out, .admin-only.hidden, .super-admin-only.hidden { transform: scale(0.85); opacity: 0; width: 0 !important; padding: 0 !important; margin: 0 !important; pointer-events: none; overflow: hidden; }
        
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }
        .rota-table th, .audit-table th { padding: 12px 16px; text-align: left; font-weight: 600; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.05em; }
        .rota-table td, .audit-table td { padding: 12px 16px; }
        .rota-table tbody tr, .audit-table tbody tr { border-bottom-width: 1px; }
        .rota-table tbody tr:last-child, .audit-table tbody tr:last-child { border-bottom-width: 0; }
        .rota-table tbody tr.current-month { background-color: #e0f2fe; }
        .dark .rota-table tbody tr.current-month { background-color: #0c4a6e; } /* Dark mode for current month */

        .filter-btn { transition: all 0.3s ease; }
        .filter-btn.active { background-color: #2397cf; color: white; }

        .reveal { opacity: 0; transform: translateY(30px); transition: opacity 0.6s ease-out, transform 0.6s ease-out; }
        .reveal.visible { opacity: 1; transform: translateY(0); }

        .attendance-buttons.selected .selected-btn {
            border: 3px solid #29aae2;
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }
        .attendance-buttons.selected button:not(.selected-btn) {
            opacity: 0.6;
            transition: opacity 0.2s ease-in-out;
        }
        .attendance-buttons.selected button:not(.selected-btn):hover {
            opacity: 1;
        }

        #mobile-menu { transition: opacity 0.3s ease-in-out; }
        #mobile-menu nav a { opacity: 0; transform: translateY(20px); transition: opacity 0.4s ease, transform 0.4s ease; }
        body.menu-open #mobile-menu nav a { opacity: 1; transform: translateY(0); }
        
        #main-login-overlay {
            background-image: url('5.png');
            background-size: cover;
            background-position: center;
            transition: opacity 0.5s ease-in-out;
        }

        .content-hidden {
            display: none !important;
        }
        
        /* New Tab Styles */
        .generator-tab-btn.active {
            color: #29aae2;
            border-color: #29aae2;
        }
        .attendance-tab-button.active {
            background-color: #29aae2;
            color: white !important;
        }
        .attendance-tab-button.active span, .attendance-tab-button.active i {
            color: white !important;
        }
        
        .attendance-tab-button:not(.active) {
            color: #475569; /* slate-600 */
        }
        .dark .attendance-tab-button:not(.active) {
            color: #cbd5e1; /* slate-300 */
        }
        .attendance-tab-button:not(.active):hover {
            background-color: #e2e8f0; /* slate-200 */
        }
        .dark .attendance-tab-button:not(.active):hover {
            background-color: #334155; /* slate-700 */
        }

        .admin-only-input:disabled {
            background-color: #f8fafc;
            cursor: not-allowed;
            color: #94a3b8;
        }
        .dark .admin-only-input:disabled {
            background-color: #1e293b; /* slate-800 */
            color: #64748b; /* slate-500 */
        }
        
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out, padding 0.3s ease-in-out;
        }
        .accordion-header.active + .accordion-content {
            max-height: 1000px; /* Adjust as needed */
        }
        .accordion-header i {
            transition: transform 0.3s ease;
        }
        .accordion-header.active i {
            transform: rotate(180deg);
        }
        
        /* Playlist Modal Styles */
        .playlist-item {
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .playlist-item.active, .playlist-item:hover {
            background-color: #f0fdfa; /* teal-50 */
            border-color: #14b8a6; /* teal-500 */
        }
        .dark .playlist-item.active, .dark .playlist-item:hover {
            background-color: #115e59; /* teal-900 */
            border-color: #2dd4bf; /* teal-400 */
        }

        /* Toggle Switch Styles */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 28px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: #29aae2;
        }
        input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }

    </style>

        <script>
        (function disableInspect() {
        // Bloqueia clique direito
        document.addEventListener('contextmenu', e => e.preventDefault());

        // Bloqueia F12, Ctrl+Shift+I/J, Ctrl+U
        document.addEventListener('keydown', e => {
            const forbidden =
            e.key === 'F12' ||
            (e.ctrlKey && e.shiftKey && ['I', 'J'].includes(e.key)) ||
            (e.ctrlKey && e.key === 'U');
            if (forbidden) e.preventDefault();
        });

        // Impede abertura do console pelo DevTools
        Object.defineProperty(window, 'console', {
            get() { throw new Error('Acesso ao console bloqueado'); }
        });
        })();
    </script>
</head>
<body class="bg-brand-background dark:bg-slate-900 text-brand-text dark:text-slate-300 font-sans">

    <script>
      // Este código registra o Service Worker para o PWA
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./service-worker.js').then(registration => {
            console.log('Service Worker registrado com sucesso!');
          }).catch(err => {
            console.log('Falha ao registrar o Service Worker: ', err);
          });
        });
      }
    </script>

</head>
<body class="bg-brand-background dark:bg-slate-900 text-brand-text dark:text-slate-300 font-sans">

    <div id="main-login-overlay" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900 bg-opacity-60 backdrop-blur-sm"></div>
        <div class="relative bg-white dark:bg-slate-800 w-full max-w-sm p-8 rounded-2xl shadow-2xl text-center">
            <div class="mb-6">
                <h1 class="text-4xl font-bold font-anton text-brand-blue tracking-wider">UZIEL</h1>
                <p class="text-slate-500 dark:text-slate-400">Bem-vindo ao Portal do Ministério</p>
            </div>
            <p class="text-slate-600 dark:text-slate-300 mb-6">Por favor, insira suas credenciais para continuar.</p>
            <form id="main-login-form">
                <div class="space-y-4">
                    <div>
                        <label for="main-username" class="sr-only">Usuário</label>
                        <input type="text" id="main-username" placeholder="Usuário" class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm focus:border-brand-blue focus:ring focus:ring-brand-blue focus:ring-opacity-50" required>
                    </div>
                    <div>
                        <label for="main-password" class="sr-only">Senha</label>
                        <input type="password" id="main-password" placeholder="Senha" class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm focus:border-brand-blue focus:ring focus:ring-brand-blue focus:ring-opacity-50" required>
                    </div>
                </div>
                <p id="main-login-error" class="text-red-500 text-sm h-4 mt-4 mb-2"></p>
                <button type="submit" class="w-full bg-brand-blue text-white font-bold py-3 px-6 rounded-full hover:bg-brand-dark-blue transition-all shadow-md hover:shadow-lg">Entrar</button>
            </form>
        </div>
    </div>


    <header id="header" class="py-4 px-6 fixed w-full z-50 top-0 transition-all duration-300 content-hidden">
        <div class="container mx-auto flex justify-between items-center">
            <a href="#home" class="flex items-center gap-4">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold font-anton text-white tracking-wider transition-all duration-300">UZIEL</h1>
                    <p class="text-sm text-slate-300 -mt-1 hidden sm:block transition-colors duration-300">Portal do Ministério</p>
                </div>
            </a>
            <nav class="hidden lg:flex items-center gap-6">
                <a href="#home" class="font-medium text-slate-200 hover:text-white transition-colors duration-300">Início</a>
                <a href="#portal" class="font-medium text-slate-200 hover:text-white transition-colors duration-300">Ferramentas</a>
                <a href="#verse" class="font-medium text-slate-200 hover:text-white transition-colors duration-300">Inspiração</a>
                <a href="https://docs.google.com/forms/d/1VF8dLdhjZnqK4_K2r_-ELXhV1frXMRdSZF-ORHR-TZA/edit?usp=drivesdk" id="header-cta-btn" target="_blank" class="bg-brand-blue text-white font-semibold px-5 py-2 rounded-full hover:bg-brand-dark-blue transition-all shadow-md hover:shadow-lg hover:scale-105">Seja Membro</a>
                <!-- Botão de Tema AQUI -->
                <button id="desktop-theme-toggle" class="theme-toggle-btn text-slate-200 hover:text-white w-10 h-10 rounded-full flex items-center justify-center" aria-label="Alternar tema">
                    <i class="fas fa-moon text-lg"></i>
                    <i class="fas fa-sun text-lg hidden"></i>
                </button>
            </nav>
            <div class="flex items-center gap-2 lg:hidden">
                <button id="mobile-theme-toggle" class="theme-toggle-btn text-white w-10 h-10 rounded-full flex items-center justify-center transition-colors duration-300" aria-label="Alternar tema">
                     <i class="fas fa-moon text-lg"></i>
                     <i class="fas fa-sun text-lg hidden"></i>
                </button>
                <button id="mobile-menu-button" class="z-[61] text-white transition-colors duration-300 w-10 h-10">
                    <i id="menu-open-icon" class="fas fa-bars fa-lg"></i>
                    <i id="menu-close-icon" class="fas fa-times fa-lg hidden"></i>
                </button>
            </div>
        </div>
    </header>
    <div id="mobile-menu" class="fixed inset-0 bg-brand-background dark:bg-slate-900 z-[60] flex items-center justify-center opacity-0 pointer-events-none">
        <nav class="flex flex-col items-center justify-center h-full gap-8">
            <a href="#home" class="mobile-nav-link text-3xl font-semibold text-slate-700 dark:text-slate-200">Início</a>
            <a href="#portal" class="mobile-nav-link text-3xl font-semibold text-slate-700 dark:text-slate-200" style="transition-delay: 100ms">Ferramentas</a>
            <a href="#verse" class="mobile-nav-link text-3xl font-semibold text-slate-700 dark:text-slate-200" style="transition-delay: 200ms">Inspiração</a>
            <a href="#" id="mobile-header-cta-btn" target="_blank" class="mobile-nav-link mt-4 bg-brand-blue text-white font-semibold px-8 py-3 rounded-full text-xl" style="transition-delay: 300ms">Seja Membro</a>
        </nav>
    </div>
    <main class="content-hidden">
        <section id="home" class="pt-32 pb-16 md:pt-48 md:pb-24 text-white">
             <div class="overlay"></div>
             <div class="content-wrapper container mx-auto px-6 text-center">
                 <h2 class="text-4xl md:text-6xl font-bold mb-4 reveal" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">Bem-vindo ao nosso Portal</h2>
                 <p class="max-w-3xl mx-auto text-lg text-slate-200 mb-8 reveal" style="transition-delay: 150ms; text-shadow: 1px 1px 3px rgba(0,0,0,0.5);">Um espaço dedicado para organizar, inspirar e fortalecer a nossa comunidade. Explore os recursos e conecte-se.</p>
                 <div class="reveal" style="transition-delay: 300ms;">
             </div>
        </section>
        <section id="filters-section" class="py-10 sticky top-[76px] md:top-[84px] bg-brand-background/95 dark:bg-slate-900/95 backdrop-blur-sm z-40 border-b border-slate-200 dark:border-slate-800">
            <div class="container mx-auto px-6 flex flex-col sm:flex-row justify-center items-center gap-4">
                <h3 class="font-semibold text-slate-600 dark:text-slate-400 hidden md:block">Navegar por:</h3>
                <nav id="category-filters" class="flex flex-wrap items-center justify-center gap-2 bg-slate-100 dark:bg-slate-800 p-2 rounded-full shadow-inner">
                        <button class="filter-btn active px-4 py-1.5 text-sm font-semibold rounded-full text-slate-600 dark:text-slate-300" data-category="all">Todos</button>
                        <button class="filter-btn px-4 py-1.5 text-sm font-semibold rounded-full text-slate-600 dark:text-slate-300" data-category="media">Mídia & Música</button>
                        <button class="filter-btn px-4 py-1.5 text-sm font-semibold rounded-full text-slate-600 dark:text-slate-300" data-category="liturgy">Liturgia</button>
                        <button class="filter-btn px-4 py-1.5 text-sm font-semibold rounded-full text-slate-600 dark:text-slate-300" data-category="organization">Organização</button>
                </nav>
            </div>
        </section>
        <section id="portal" class="py-16 md:py-20 bg-brand-light-gray dark:bg-slate-950">
            <div class="container mx-auto px-6">
                <div id="card-grid" class="flex flex-wrap justify-center -m-3">
                    <div class="portal-card-wrapper w-full sm:w-1/2 md:w-1/3 lg:w-1/4 p-3 reveal" data-category="media"><a href="https://drive.google.com/drive/folders/1Feuv0be087x3zRc9hmecsKO4ZSEMcD3Q?usp=drive_link" target="_blank" class="portal-card bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg flex flex-col items-center text-center h-full"><div class="bg-purple-100 text-purple-600 rounded-full w-16 h-16 mb-4 flex items-center justify-center flex-shrink-0"><i class="fas fa-photo-video fa-2x"></i></div><div class="flex flex-col flex-grow"><h3 class="font-bold text-xl text-brand-text dark:text-white mb-1">Mídias</h3><p class="text-slate-500 dark:text-slate-400 text-sm">Acesse nosso acervo de fotos e vídeos.</p></div></a></div>
                    <div class="portal-card-wrapper w-full sm:w-1/2 md:w-1/3 lg:w-1/4 p-3 reveal" data-category="media"><div id="open-playlist-modal" class="portal-card bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg flex flex-col items-center text-center cursor-pointer h-full"><div class="bg-green-100 text-green-600 rounded-full w-16 h-16 mb-4 flex items-center justify-center flex-shrink-0"><i class="fab fa-spotify fa-2x"></i></div><div class="flex flex-col flex-grow"><h3 class="font-bold text-xl text-brand-text dark:text-white mb-1">Playlists</h3><p class="text-slate-500 dark:text-slate-400 text-sm">Nossas seleções de músicas para inspirar.</p></div></div></div>
                    <div class="portal-card-wrapper w-full sm:w-1/2 md:w-1/3 lg:w-1/4 p-3 reveal" data-category="media"><a href="https://musicasparamissa.com.br/" target="_blank" class="portal-card bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg flex flex-col items-center text-center h-full"><div class="bg-pink-100 text-pink-600 rounded-full w-16 h-16 mb-4 flex items-center justify-center flex-shrink-0"><i class="fas fa-music fa-2x"></i></div><div class="flex flex-col flex-grow"><h3 class="font-bold text-xl text-brand-text dark:text-white mb-1">Músicas para Missa</h3><p class="text-slate-500 dark:text-slate-400 text-sm">Veja as musicas mais adquadas para as celebrações.</p></div></a></div>
                    <div class="portal-card-wrapper w-full sm:w-1/2 md:w-1/3 lg:w-1/4 p-3 reveal" data-category="liturgy"><a href="https://santuarionsamordivino.com.br/liturgia-eucaristica-novo-missal-romano/" target="_blank" class="portal-card bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg flex flex-col items-center text-center h-full"><div class="bg-amber-100 text-amber-600 rounded-full w-16 h-16 mb-4 flex items-center justify-center flex-shrink-0"><i class="fas fa-cross fa-2x"></i></div><div class="flex flex-col flex-grow"><h3 class="font-bold text-xl text-brand-text dark:text-white mb-1">Oração Eucarística</h3><p class="text-slate-500 dark:text-slate-400 text-sm">Acesse as orações para os momentos de adoração.</p></div></a></div>
                    <div class="portal-card-wrapper w-full sm:w-1/2 md:w-1/3 lg:w-1/4 p-3 reveal" data-category="liturgy"><a href="https://www.cnbb.org.br/liturgia-diaria/" target="_blank" class="portal-card bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg flex flex-col items-center text-center h-full"><div class="bg-yellow-100 text-yellow-600 rounded-full w-16 h-16 mb-4 flex items-center justify-center flex-shrink-0"><i class="fas fa-book-open fa-2x"></i></div><div class="flex flex-col flex-grow"><h3 class="font-bold text-xl text-brand-text dark:text-white mb-1">Liturgia Diária</h3><p class="text-slate-500 dark:text-slate-400 text-sm">Consulte as leituras e o salmo do dia.</p></div></a></div>
                    <div class="portal-card-wrapper w-full sm:w-1/2 md:w-1/3 lg:w-1/4 p-3 reveal" data-category="liturgy"><div id="open-rota-modal" class="portal-card bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg flex flex-col items-center text-center cursor-pointer h-full"><div class="bg-cyan-100 text-cyan-600 rounded-full w-16 h-16 mb-4 flex items-center justify-center flex-shrink-0"><i class="fas fa-calendar-alt fa-2x"></i></div><div class="flex flex-col flex-grow"><h3 class="font-bold text-xl text-brand-text dark:text-white mb-1">Escala de Salmistas</h3><p class="text-slate-500 dark:text-slate-400 text-sm">Confira a programação anual dos salmos.</p></div></div></div>
                    <div class="portal-card-wrapper w-full sm:w-1/2 md:w-1/3 lg:w-1/4 p-3 reveal" data-category="organization"><div id="open-statute-modal" class="portal-card bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg flex flex-col items-center text-center cursor-pointer h-full"><div class="bg-slate-100 text-slate-600 rounded-full w-16 h-16 mb-4 flex items-center justify-center flex-shrink-0"><i class="fas fa-file-contract fa-2x"></i></div><div class="flex flex-col flex-grow"><h3 class="font-bold text-xl text-brand-text dark:text-white mb-1">Estatuto</h3><p class="text-slate-500 dark:text-slate-400 text-sm">Consulte as diretrizes do ministério.</p></div></div></div>
                    <div class="portal-card-wrapper w-full sm:w-1/2 md:w-1/3 lg:w-1/4 p-3 reveal" data-category="organization"><div id="open-pptx-generator-modal" class="portal-card bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg flex flex-col items-center text-center cursor-pointer h-full"><div class="bg-orange-100 text-orange-600 rounded-full w-16 h-16 mb-4 flex items-center justify-center flex-shrink-0"><i class="fas fa-file-export fa-2x"></i></div><div class="flex flex-col flex-grow"><h3 class="font-bold text-xl text-brand-text dark:text-white mb-1">Gerador de Arquivos</h3><p class="text-slate-500 dark:text-slate-400 text-sm">Crie PPTX, PDF e visualize o repertório.</p></div></div></div>
                    <div class="portal-card-wrapper w-full sm:w-1/2 md:w-1/3 lg:w-1/4 p-3 reveal" data-category="organization"><a href="https://docs.google.com/forms/d/1VF8dLdhjZnqK4_K2r_-ELXhV1frXMRdSZF-ORHR-TZA/edit?usp=drivesdk" target="_blank" class="portal-card bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg flex flex-col items-center text-center h-full"><div class="bg-sky-100 text-sky-600 rounded-full w-16 h-16 mb-4 flex items-center justify-center flex-shrink-0"><i class="fas fa-user-plus fa-2x"></i></div><div class="flex flex-col flex-grow"><h3 class="font-bold text-xl text-brand-text dark:text-white mb-1">Novos Membros</h3><p class="text-slate-500 dark:text-slate-400 text-sm">Questionário para quem deseja se juntar a nós.</p></div></a></div>
                    <div class="portal-card-wrapper w-full sm:w-1/2 md:w-1/3 lg:w-1/4 p-3 reveal" data-category="organization"><a href="https://drive.google.com/file/d/1Nt1H12O73Xk9GtnVa2P0U3xx9zTZe-gu/view?usp=drivesdk" target="_blank" class="portal-card bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg flex flex-col items-center text-center h-full"><div class="bg-slate-100 text-slate-600 rounded-full w-16 h-16 mb-4 flex items-center justify-center flex-shrink-0"><i class="fas fa-sitemap fa-2x"></i></div><div class="flex flex-col flex-grow"><h3 class="font-bold text-xl text-brand-text dark:text-white mb-1">Organograma</h3><p class="text-slate-500 dark:text-slate-400 text-sm">Conheça a estrutura de liderança.</p></div></a></div>
                    <div class="portal-card-wrapper w-full sm:w-1/2 md:w-1/3 lg:w-1/4 p-3 reveal" data-category="organization"><a href="https://docs.google.com/document/d/1_DUy9LPo1L1ZV_bxB1Sa5P8ySR6zZdmPD3qs6B_-gZY/edit?usp=drivesdk" target="_blank" class="portal-card bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg flex flex-col items-center text-center h-full"><div class="bg-slate-100 text-slate-600 rounded-full w-16 h-16 mb-4 flex items-center justify-center flex-shrink-0"><i class="fas fa-cogs fa-2x"></i></div><div class="flex flex-col flex-grow"><h3 class="font-bold text-xl text-brand-text dark:text-white mb-1">Processos</h3><p class="text-slate-500 dark:text-slate-400 text-sm">Entenda nossos fluxos e procedimentos.</p></div></a></div>
                    <div class="portal-card-wrapper w-full sm:w-1/2 md:w-1/3 lg:w-1/4 p-3 reveal" data-category="organization"><a href="#" target="_blank" class="portal-card bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg flex flex-col items-center text-center h-full"><div class="bg-teal-100 text-teal-600 rounded-full w-16 h-16 mb-4 flex items-center justify-center flex-shrink-0"><i class="fas fa-hands-helping fa-2x"></i></div><div class="flex flex-col flex-grow"><h3 class="font-bold text-xl text-brand-text dark:text-white mb-1">Ação Social</h3><p class="text-slate-500 dark:text-slate-400 text-sm">Veja nossos projetos e como participar.</p></div></a></div>
                    <div class="portal-card-wrapper w-full sm:w-1/2 md:w-1/3 lg:w-1/4 p-3 reveal" data-category="organization"><a href="https://docs.google.com/forms/d/e/1FAIpQLSfUkS-wHsisihvP-QDA4tgo9N8k8e5eHCn-CLoyghEqVgcY8A/viewform" target="_blank" class="portal-card bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg flex flex-col items-center text-center h-full"><div class="bg-red-100 text-red-600 rounded-full w-16 h-16 mb-4 flex items-center justify-center flex-shrink-0"><i class="fas fa-shield-alt fa-2x"></i></div><div class="flex flex-col flex-grow"><h3 class="font-bold text-xl text-brand-text dark:text-white mb-1">Canal de Denúncias</h3><p class="text-slate-500 dark:text-slate-400 text-sm">Relato seguro e anônimo.</p></div></a></div>
                    <div class="portal-card-wrapper w-full sm:w-1/2 md:w-1/3 lg:w-1/4 p-3 reveal" data-category="organization"><a href="https://docs.google.com/forms/d/e/1FAIpQLSfPhK1m2uOWOioOxDj-oI5xuueDQylWlXgKbnjtEA1gAI0ahg/viewform" target="_blank" class="portal-card bg-white dark:bg-slate-800 p-6 rounded-xl shadow-lg flex flex-col items-center text-center h-full"><div class="bg-blue-100 text-blue-600 rounded-full w-16 h-16 mb-4 flex items-center justify-center flex-shrink-0"><i class="fas fa-lightbulb fa-2x"></i></div><div class="flex flex-col flex-grow"><h3 class="font-bold text-xl text-brand-text dark:text-white mb-1">Críticas e Sugestões</h3><p class="text-slate-500 dark:text-slate-400 text-sm">Sua opinião é importante para nós.</p></div></a></div>
                    <div class="portal-card-wrapper w-full sm:w-1/2 md:w-1/3 lg:w-1/4 p-3 reveal" data-category="organization"><div id="open-attendance-trigger" class="portal-card bg-brand-blue p-6 rounded-xl shadow-lg flex flex-col items-center text-center h-full cursor-pointer"><div class="bg-white/90 text-brand-blue rounded-full w-16 h-16 mb-4 flex items-center justify-center flex-shrink-0"><i class="fas fa-user-check fa-2x"></i></div><div class="flex flex-col flex-grow"><h3 class="font-bold text-xl text-white mb-1">Controle de Presença</h3><p class="text-blue-100 text-sm">Registre presenças, ausências e consulte pontuações.</p></div></div></div>
                    <div id="user-management-card-wrapper" class="admin-only hidden portal-card-wrapper w-full sm:w-1/2 md:w-1/3 lg:w-1/4 p-3 reveal" data-category="organization">
                        <div id="open-user-management-modal" class="portal-card bg-slate-800 p-6 rounded-xl shadow-lg flex flex-col items-center text-center h-full cursor-pointer">
                            <div class="bg-white/90 text-slate-800 rounded-full w-16 h-16 mb-4 flex items-center justify-center flex-shrink-0"><i class="fas fa-users-cog fa-2x"></i></div>
                            <div class="flex flex-col flex-grow">
                                <h3 class="font-bold text-xl text-white mb-1">Gerenciar Usuários</h3>
                                <p class="text-slate-300 text-sm">Adicionar, remover ou editar usuários do portal.</p>
                            </div>
                        </div>
                    </div>
                    <div id="audit-log-card-wrapper" class="super-admin-only hidden portal-card-wrapper w-full sm:w-1/2 md:w-1/3 lg:w-1/4 p-3 reveal" data-category="organization">
                        <div id="open-audit-log-modal" class="portal-card bg-gray-800 p-6 rounded-xl shadow-lg flex flex-col items-center text-center h-full cursor-pointer">
                            <div class="bg-white/90 text-gray-800 rounded-full w-16 h-16 mb-4 flex items-center justify-center flex-shrink-0"><i class="fas fa-history fa-2x"></i></div>
                            <div class="flex flex-col flex-grow">
                                <h3 class="font-bold text-xl text-white mb-1">Rastreabilidade</h3>
                                <p class="text-gray-300 text-sm">Verificar logs de atividades dos usuários.</p>
                            </div>
                        </div>  
                    </div>
                    <div id="whatsapp-config-card-wrapper" class="super-admin-only hidden portal-card-wrapper w-full sm:w-1/2 md:w-1/3 lg:w-1/4 p-3 reveal" data-category="organization">
                        <div id="open-whatsapp-config-modal" class="portal-card bg-green-700 p-6 rounded-xl shadow-lg flex flex-col items-center text-center h-full cursor-pointer">
                            <div class="bg-white/90 text-green-700 rounded-full w-16 h-16 mb-4 flex items-center justify-center flex-shrink-0"><i class="fab fa-whatsapp fa-2x"></i></div>
                            <div class="flex flex-col flex-grow">
                                <h3 class="font-bold text-xl text-white mb-1">Configurar Notificações</h3>
                                <p class="text-green-200 text-sm">Gerenciar números e remetente do WhatsApp.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <section id="verse" class="py-16 md:py-24 text-white">
            <div class="overlay"></div>
            <div class="content-wrapper container mx-auto px-6 text-center reveal">
                <i class="fas fa-quote-left fa-3x text-brand-blue mb-6"></i>
                <blockquote id="verse-text" class="text-2xl md:text-3xl font-light max-w-4xl mx-auto mb-4 italic" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">Carregando versículo...</blockquote>
                <cite id="verse-reference" class="text-brand-blue font-semibold text-lg not-italic">...</cite>
            </div>
        </section>
    </main>
    
    <div id="statute-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 z-[51] flex items-center justify-center p-4 hidden opacity-0" role="dialog" aria-modal="true" aria-labelledby="statute-modal-title"><div class="modal-content bg-white dark:bg-slate-800 w-full max-w-lg p-6 rounded-2xl shadow-2xl text-center scale-95 opacity-0"><div class="flex justify-between items-center mb-6"><div class="flex items-center gap-3"><i class="fas fa-file-contract text-brand-blue text-2xl"></i><h3 id="statute-modal-title" class="text-2xl font-bold text-brand-text dark:text-white">Estatuto do Ministério</h3></div><button id="close-statute-modal" class="text-slate-400 hover:text-slate-800 dark:hover:text-white text-2xl">×</button></div><p class="text-slate-500 dark:text-slate-400 mb-6">Escolha a versão do documento que deseja consultar.</p><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><a href="https://drive.google.com/file/d/1hzVoqTGXw0pBBOTUG7PuIkTjZVrk_cKe/view?usp=drivesdk" target="_blank" class="group block text-left bg-brand-light-gray dark:bg-slate-700 p-5 rounded-lg border border-slate-200 dark:border-slate-600 hover:border-brand-blue hover:bg-white dark:hover:bg-slate-600 transition-all duration-300"><i class="fas fa-file-signature text-brand-blue text-2xl mb-2"></i><h4 class="font-bold text-lg text-brand-text dark:text-white">Estatuto Novo</h4><p class="text-sm text-slate-500 dark:text-slate-400">Versão mais recente e vigente das nossas diretrizes.</p></a><a href="https://drive.google.com/file/d/1sCjQkqn7VN0aanL0XvfuSocXregwZs_O/view?usp=drivesdk" target="_blank" class="group block text-left bg-brand-light-gray dark:bg-slate-700 p-5 rounded-lg border border-slate-200 dark:border-slate-600 hover:border-brand-blue hover:bg-white dark:hover:bg-slate-600 transition-all duration-300"><i class="fas fa-archive text-slate-500 group-hover:text-brand-blue text-2xl mb-2"></i><h4 class="font-bold text-lg text-brand-text dark:text-white">Estatuto Antigo</h4><p class="text-sm text-slate-500 dark:text-slate-400">Versão anterior para consulta de histórico.</p></a></div></div></div>
    <div id="rota-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 z-[51] flex items-center justify-center p-4 hidden opacity-0" role="dialog" aria-modal="true" aria-labelledby="rota-modal-title"><div class="modal-content bg-white dark:bg-slate-800 w-full max-w-4xl p-0 rounded-2xl shadow-2xl scale-95 opacity-0 overflow-hidden"><div class="flex justify-between items-center p-6 border-b border-slate-200 dark:border-slate-700"><div class="flex items-center gap-3"><i class="fas fa-calendar-check text-brand-blue text-2xl"></i><h3 id="rota-modal-title" class="text-2xl font-bold text-brand-text dark:text-white">Escala de Salmistas Anual</h3></div><button id="regenerate-rota-btn" class="hidden bg-brand-blue text-white font-semibold py-1.5 px-4 rounded-full hover:bg-brand-dark-blue transition-all shadow-md text-sm ml-auto mr-4"><i class="fas fa-random mr-2"></i>Gerar Nova Lista</button><button id="close-rota-modal" class="text-slate-400 hover:text-slate-800 dark:hover:text-white text-2xl">×</button></div><div id="rota-loading" class="text-center py-12"><i class="fas fa-spinner fa-spin text-brand-blue text-4xl"></i><p class="mt-4 text-slate-600 dark:text-slate-300">Gerando escala anual...</p></div><div id="rota-content" class="hidden"><div class="max-h-[60vh] overflow-y-auto"><table class="w-full text-sm text-slate-700 dark:text-slate-300 rota-table"><thead class="sticky top-0 bg-slate-100 dark:bg-slate-700 z-10"><tr><th>Data (1º Domingo)</th><th>Salmista</th><th>Substituto(a)</th></tr></thead><tbody id="rota-table-body" class="bg-white dark:bg-slate-800"></tbody></table></div><div class="p-4 bg-slate-50 dark:bg-slate-900 border-t border-slate-200 dark:border-slate-700 text-xs text-slate-500 dark:text-slate-400 text-center">Esta escala é gerada automaticamente para o período de um ano a partir do mês atual.</div></div></div></div>
    
    <!-- ========== PLAYLIST MODAL (MODERNIZED) ========== -->
    <div id="playlist-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 z-[51] flex items-center justify-center p-4 hidden opacity-0" role="dialog" aria-modal="true" aria-labelledby="playlist-modal-title">
        <div class="modal-content bg-slate-50 dark:bg-slate-900 w-full max-w-4xl h-[85vh] p-0 rounded-2xl shadow-2xl scale-95 opacity-0 overflow-hidden flex flex-col">
            <div class="flex-shrink-0 flex justify-between items-center p-6 border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">
                <div class="flex items-center gap-4">
                    <i class="fab fa-spotify text-green-500 text-3xl"></i>
                    <div>
                        <h3 id="playlist-modal-title" class="text-2xl font-bold text-brand-text dark:text-white">Playlists</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400">Nossas seleções de músicas para inspirar.</p>
                    </div>
                </div>
                <button id="close-playlist-modal" class="text-slate-400 hover:text-slate-800 dark:hover:text-white text-2xl">×</button>
            </div>
            
            <div class="flex-grow flex flex-col md:flex-row gap-6 p-6 overflow-y-auto">
                <!-- Left Column: Playlist List -->
                <div class="w-full md:w-1/3 flex flex-col gap-4">
                    <!-- Admin-only Add Form -->
                    <form id="add-playlist-form" class="hidden admin-only bg-white dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-700">
                        <h4 class="font-bold text-brand-text dark:text-white mb-2">Adicionar Nova Playlist</h4>
                        <div class="flex items-center gap-2">
                            <input type="url" id="new-playlist-url" placeholder="Cole o link do Spotify ou YouTube" class="flex-grow w-full text-sm rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm" required>
                            <button type="submit" class="flex-shrink-0 bg-green-600 text-white p-2 rounded-full hover:bg-green-700 transition-all" title="Adicionar Playlist">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                         <p id="playlist-form-feedback" class="text-xs text-red-500 h-3 mt-1"></p>
                    </form>
                    
                    <h4 class="font-semibold text-slate-600 dark:text-slate-400 mt-2">Playlists Salvas</h4>
                    <div id="playlist-list-container" class="flex-grow space-y-2 overflow-y-auto pr-2">
                        <!-- Playlists will be dynamically inserted here -->
                        <div class="text-center text-slate-500 dark:text-slate-400 py-8">
                            <i class="fas fa-spinner fa-spin text-2xl"></i>
                            <p class="mt-2 text-sm">Carregando...</p>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Embed Viewer -->
                <div id="playlist-embed-container" class="w-full md:w-2/3 bg-white dark:bg-slate-800 p-4 rounded-lg border dark:border-slate-700 flex items-center justify-center">
                    <div class="text-center text-slate-400">
                        <i class="fas fa-arrow-left fa-2x mb-3"></i>
                        <p class="font-semibold">Selecione uma playlist para visualizar</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="pptx-generator-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 z-[51] flex items-center justify-center p-4 hidden opacity-0" role="dialog" aria-modal="true" aria-labelledby="pptx-generator-modal-title">
        <div class="modal-content bg-slate-50 dark:bg-slate-900 w-full max-w-5xl h-[90vh] p-0 rounded-2xl shadow-2xl scale-95 opacity-0 overflow-hidden flex flex-col">
            
            <div class="flex-shrink-0 flex justify-between items-center p-6 border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">
                <div class="flex items-center gap-4">
                    <i class="fas fa-file-export text-brand-blue text-3xl"></i>
                    <div>
                        <h3 id="pptx-generator-modal-title" class="text-2xl font-bold text-brand-text dark:text-white">Gerador de Arquivos</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400">Crie PPTX, PDF e visualize o repertório da celebração.</p>
                    </div>
                </div>
                <button id="close-pptx-generator-modal" class="text-slate-400 hover:text-slate-800 dark:hover:text-white text-2xl">×</button>
            </div>

            <div id="generator-tabs" class="flex-shrink-0 border-b border-slate-200 dark:border-slate-700 px-6 bg-white dark:bg-slate-800">
                <nav class="flex space-x-4 -mb-px">
                    <button data-tab="montar" class="generator-tab-btn font-semibold py-4 px-2 border-b-2 border-transparent text-slate-500 hover:text-brand-blue dark:text-slate-400 dark:hover:text-brand-blue">Montar Repertório</button>
                    <button data-tab="historico" class="generator-tab-btn font-semibold py-4 px-2 border-b-2 border-transparent text-slate-500 hover:text-brand-blue dark:text-slate-400 dark:hover:text-brand-blue">Histórico</button>
                    <button data-tab="visualizar" class="generator-tab-btn font-semibold py-4 px-2 border-b-2 border-transparent text-slate-500 hover:text-brand-blue dark:text-slate-400 dark:hover:text-brand-blue hidden">Visualizar</button>
                </nav>
            </div>

            <div class="flex-grow overflow-y-auto">
                <div id="tab-montar" class="generator-tab-pane p-6">
                    <form id="pptx-form">
                        <input type="hidden" id="repertory-id">
                        <!-- Informações da Missa -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label for="mass-date" class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1">Data da Missa</label>
                                <input type="date" id="mass-date" class="admin-only-input block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm focus:border-brand-blue focus:ring focus:ring-brand-blue focus:ring-opacity-50">
                            </div>
                            <div>
                                <label for="mass-theme" class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1">Tema / Ocasião (Opcional)</label>
                                <input type="text" id="mass-theme" placeholder="Ex: Festa do Padroeiro, Missa de Ramos" class="admin-only-input block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm focus:border-brand-blue focus:ring focus:ring-brand-blue focus:ring-opacity-50">
                            </div>
                        </div>

                        <!-- Seção para Adicionar Cânticos -->
                        <div class="bg-white dark:bg-slate-800 p-4 rounded-lg border dark:border-slate-700 mb-6 admin-only-input-area">
                        <h4 class="font-bold text-brand-text dark:text-white mb-3">Adicionar Cântico ao Repertório</h4>
                        <div class="flex flex-col sm:flex-row items-end gap-4">
                            <div id="song-type-selector-wrapper" class="flex-grow w-full sm:w-auto">
                                <label for="song-type-selector" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Tipo de Cântico</label>
                                <select id="song-type-selector" class="admin-only-input mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm"></select>
                            </div>

                            <div id="custom-song-type-wrapper" class="hidden flex-grow w-full sm:w-auto">
                                <label for="custom-song-type-input" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Nome do Cântico Personalizado</label>
                                <input type="text" id="custom-song-type-input" placeholder="Ex: Cântico de Meditação" class="admin-only-input mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm focus:border-brand-blue focus:ring focus:ring-brand-blue focus:ring-opacity-50">
                            </div>

                            <button type="button" id="add-song-btn" class="admin-only-input w-full sm:w-auto bg-brand-blue text-white font-semibold py-2 px-4 rounded-md hover:bg-brand-dark-blue transition-all">
                                <i class="fas fa-plus mr-2"></i>Adicionar
                            </button>
                        </div>
                    </div>
                        
                        <!-- Container para os Cânticos Adicionados -->
                        <div id="dynamic-song-fields-container" class="space-y-4">
                            <!-- Cânticos adicionados dinamicamente aparecerão aqui -->
                        </div>
                    </form>
                </div>

                <div id="tab-historico" class="generator-tab-pane p-6 hidden">
                     <div class="flex justify-between items-center mb-4">
                         <h4 class="text-xl font-bold text-brand-text dark:text-white">Histórico de Repertórios</h4>
                         <button id="clear-repertory-history-btn" title="Limpar todo o histórico" class="bg-red-600 text-white font-semibold py-1.5 px-4 rounded-full hover:bg-red-700 transition-all text-sm">
                             <i class="fas fa-trash-alt mr-2"></i>Limpar Histórico
                         </button>
                     </div>
                    <div id="repertory-history-content" class="space-y-3">
                        <div class="text-center text-slate-500 dark:text-slate-400 py-10">
                            <i class="fas fa-history fa-2x mb-3"></i>
                            <p>Nenhum repertório salvo encontrado.</p>
                        </div>
                    </div>
                </div>

                <div id="tab-visualizar" class="generator-tab-pane p-6 hidden">
                    <div id="repertory-viewer-content">
                         <div class="text-center text-slate-500 dark:text-slate-400 py-10">
                            <i class="fas fa-eye fa-2x mb-3"></i>
                            <p>Selecione um repertório no histórico para visualizar.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="generator-footer" class="flex-shrink-0 p-4 mt-auto bg-white dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700">
                <div id="generator-feedback" class="text-center text-sm mb-3 h-5 font-medium transition-opacity duration-300 opacity-0"></div>
                <div id="generator-actions" class="flex flex-wrap justify-end items-center gap-3">
                    <button id="clear-form-btn" title="Limpar formulário atual" class="bg-slate-200 text-slate-800 font-semibold py-2 px-5 rounded-full hover:bg-slate-300 transition-all dark:bg-slate-600 dark:text-white dark:hover:bg-slate-500">
                        <i class="fas fa-undo mr-2"></i>Novo
                    </button>
                    <button id="save-repertory-btn" class="bg-green-600 text-white font-bold py-2 px-5 rounded-full hover:bg-green-700 transition-all shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-wait">
                        <i class="fas fa-save mr-2"></i>Salvar Repertório
                    </button>
                    <button id="generate-pdf-btn" class="bg-red-600 text-white font-bold py-2 px-5 rounded-full hover:bg-red-700 transition-all shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-wait">
                        <i class="fas fa-file-pdf mr-2"></i>Gerar PDF
                    </button>
                    <button id="generate-pptx-btn" class="bg-brand-blue text-white font-bold py-2 px-5 rounded-full hover:bg-brand-dark-blue transition-all shadow-md hover:shadow-lg disabled:opacity-50 disabled:cursor-wait">
                        <i class="fas fa-file-powerpoint mr-2"></i>Gerar PPTX
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="attendance-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 z-[51] flex items-center justify-center p-4 hidden opacity-0" role="dialog" aria-modal="true" aria-labelledby="attendance-modal-title">
        <div class="modal-content bg-slate-50 dark:bg-slate-900 w-full max-w-6xl h-[90vh] p-0 rounded-2xl shadow-2xl scale-95 opacity-0 overflow-hidden flex flex-col">
            <div class="flex-shrink-0 flex justify-between items-center p-6 border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">
                <div class="flex items-center gap-3">
                    <i class="fas fa-user-check text-brand-blue text-2xl"></i>
                    <h3 id="attendance-modal-title" class="text-2xl font-bold text-brand-text dark:text-white">Controle de Presença e Pontuação</h3>
                </div>
                <button id="close-attendance-modal" class="text-slate-400 hover:text-slate-800 dark:hover:text-white text-2xl">×</button>
            </div>
            <div id="attendance-content-area" class="flex-grow overflow-y-auto">
                </div>
        </div>
    </div>
    
    <div id="justification-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 z-[52] flex items-center justify-center p-4 hidden opacity-0" role="dialog" aria-modal="true">
        <div class="modal-content bg-white dark:bg-slate-800 w-full max-w-md p-6 rounded-2xl shadow-2xl text-center scale-95 opacity-0">
            <h3 id="justification-title" class="text-xl font-bold text-brand-text dark:text-white mb-2">Justificar Ausência</h3>
            <p class="text-slate-600 dark:text-slate-300 mb-6">Por favor, insira uma justificativa para a ausência. Se deixar em branco, pontos serão aplicados.</p>
            <textarea id="justification-text" rows="3" class="w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm focus:border-brand-blue focus:ring-brand-blue focus:ring-opacity-50"></textarea>
            <div class="flex justify-center gap-4 mt-6">
                 <button id="cancel-justification-btn" class="bg-slate-200 text-slate-800 font-bold py-2 px-8 rounded-full hover:bg-slate-300 transition-all dark:bg-slate-600 dark:text-white dark:hover:bg-slate-500">Cancelar</button>
                 <button id="confirm-justification-btn" class="bg-red-600 text-white font-bold py-2 px-8 rounded-full hover:bg-red-700 transition-all">Confirmar Ausência</button>
            </div>
        </div>
    </div>

    <div id="edit-record-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 z-[52] flex items-center justify-center p-4 hidden opacity-0" role="dialog" aria-modal="true">
        <div class="modal-content bg-white dark:bg-slate-800 w-full max-w-lg p-0 rounded-2xl shadow-2xl scale-95 opacity-0 overflow-hidden flex flex-col">
            <div class="flex justify-between items-center p-6 border-b border-slate-200 dark:border-slate-700">
                <div class="flex items-center gap-3">
                    <i class="fas fa-edit text-brand-blue text-2xl"></i>
                    <h3 class="text-2xl font-bold text-brand-text dark:text-white">Editar Registro</h3>
                </div>
                <button id="close-edit-record-modal" class="text-slate-400 hover:text-slate-800 dark:hover:text-white text-2xl">×</button>
            </div>
            <form id="edit-record-form" class="p-6 space-y-4 max-h-[65vh] overflow-y-auto">
                <input type="hidden" id="edit-record-id">
                <input type="hidden" id="edit-member-id">
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Membro</label>
                    <p id="edit-member-name" class="mt-1 text-lg font-semibold text-slate-800 dark:text-slate-100"></p>
                </div>
                <div>
                    <label for="edit-date" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Data</label>
                    <input type="date" id="edit-date" class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm" required>
                </div>
                <div>
                    <label for="edit-event-type" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Tipo de Evento</label>
                    <select id="edit-event-type" class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm" required>
                        <option value="Missa">Missa</option>
                        <option value="Ensaio">Ensaio</option>
                        <option value="Evento">Evento</option>
                    </select>
                </div>
                 <div>
                    <label for="edit-status" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Status</label>
                    <select id="edit-status" class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm" required>
                        <option value="Presente">Presente</option>
                        <option value="Ausente">Ausente</option>
                    </select>
                </div>
                <div>
                    <label for="edit-justification" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Justificativa</label>
                    <textarea id="edit-justification" rows="3" class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm"></textarea>
                </div>
            </form>
            <div class="p-4 mt-auto bg-slate-50 dark:bg-slate-900 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-3">
                <button id="cancel-edit-btn" type="button" class="bg-slate-200 text-slate-800 font-bold py-2 px-6 rounded-full hover:bg-slate-300 transition-all dark:bg-slate-600 dark:text-white dark:hover:bg-slate-500">Cancelar</button>
                <button id="save-edit-btn" type="submit" form="edit-record-form" class="bg-brand-blue text-white font-bold py-2 px-6 rounded-full hover:bg-brand-dark-blue transition-all">Salvar Alterações</button>
            </div>
        </div>
    </div>
    
    <div id="user-management-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 z-[52] flex items-center justify-center p-4 hidden opacity-0" role="dialog" aria-modal="true">
        <div class="modal-content bg-slate-50 dark:bg-slate-900 w-full max-w-6xl h-[90vh] p-0 rounded-2xl shadow-2xl scale-95 opacity-0 overflow-hidden flex flex-col">
            <div class="flex justify-between items-center p-6 border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">
                <div class="flex items-center gap-4">
                    <i class="fas fa-users-cog text-brand-blue text-3xl"></i>
                    <div>
                        <h3 class="text-2xl font-bold text-brand-text dark:text-white">Gerenciar Usuários</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400">Adicione, edite ou remova usuários do portal</p>
                    </div>
                </div>
                <button id="close-user-management-modal" class="text-slate-400 hover:text-slate-800 dark:hover:text-white text-2xl">×</button>
            </div>
            <div class="p-6 grid grid-cols-1 lg:grid-cols-5 gap-8 flex-grow overflow-y-auto">
                <div class="lg:col-span-2 bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md">
                    <h4 class="text-xl font-bold text-brand-text dark:text-white mb-4">Adicionar Novo Usuário</h4>
                    <form id="create-user-form" class="space-y-4">
                        <div>
                            <label for="new-user-name" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Nome Completo</label>
                            <input type="text" id="new-user-name" class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm" required>
                        </div>
                        <div>
                            <label for="new-user-username" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Usuário (sem @uziel.com)</label>
                            <input type="text" id="new-user-username" class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm" required>
                        </div>
                        <div>
                            <label for="new-user-password" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Senha</label>
                            <input type="password" id="new-user-password" class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm" required>
                        </div>
                        <div>
                            <label for="new-user-role" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Nível de Acesso</label>
                            <select id="new-user-role" class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm" required>
                                <option value="member">Membro</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <p id="create-user-error" class="text-red-500 text-sm h-4"></p>
                        <button type="submit" class="w-full bg-brand-blue text-white font-bold py-3 px-6 rounded-full hover:bg-brand-dark-blue transition-transform transform hover:scale-105">Adicionar Usuário</button>
                    </form>
                </div>
                <div class="lg:col-span-3 bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md flex flex-col overflow-hidden">
                    <h4 class="text-xl font-bold text-brand-text dark:text-white mb-4 flex-shrink-0">Usuários Atuais</h4>
                    <div class="table-container border dark:border-slate-700 rounded-lg flex-grow overflow-y-auto">
                        <table class="w-full text-sm text-left text-slate-700 dark:text-slate-300 rota-table">
                            <thead class="bg-slate-100 dark:bg-slate-700 sticky top-0 z-10">
                                <tr><th>Nome</th><th>Usuário</th><th>Nível</th><th>Ações</th></tr>
                            </thead>
                            <tbody id="users-table-body" class="bg-white dark:bg-slate-800">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="edit-user-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 z-[53] flex items-center justify-center p-4 hidden opacity-0" role="dialog" aria-modal="true">
        <div class="modal-content bg-white dark:bg-slate-800 w-full max-w-lg p-0 rounded-2xl shadow-2xl scale-95 opacity-0 overflow-hidden flex flex-col">
            <div class="flex justify-between items-center p-6 border-b border-slate-200 dark:border-slate-700">
                <div class="flex items-center gap-3">
                    <i class="fas fa-user-edit text-brand-blue text-2xl"></i>
                    <h3 class="text-2xl font-bold text-brand-text dark:text-white">Editar Usuário</h3>
                </div>
                <button id="close-edit-user-modal" class="text-slate-400 hover:text-slate-800 dark:hover:text-white text-2xl">×</button>
            </div>
            <form id="edit-user-form" class="p-6 space-y-4">
                <input type="hidden" id="edit-user-original-username">
                <div>
                    <label for="edit-user-name" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Nome Completo</label>
                    <input type="text" id="edit-user-name" class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm" required>
                </div>
                <div>
                    <label for="edit-user-username-display" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Usuário</label>
                    <input type="text" id="edit-user-username-display" class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 bg-slate-100 dark:bg-slate-700 shadow-sm" disabled>
                </div>
                 <div>
                    <label for="edit-user-role" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Nível de Acesso</label>
                    <select id="edit-user-role" class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm" required>
                        <option value="member">Membro</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div>
                    <label for="edit-user-password" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Nova Senha (deixe em branco para não alterar)</label>
                    <input type="password" id="edit-user-password" placeholder="••••••••" class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm">
                </div>
                <p id="edit-user-error" class="text-red-500 text-sm h-4"></p>
            </form>
            <div class="p-4 mt-auto bg-slate-50 dark:bg-slate-900 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-3">
                <button id="cancel-edit-user-btn" type="button" class="bg-slate-200 text-slate-800 font-bold py-2 px-6 rounded-full hover:bg-slate-300 transition-all dark:bg-slate-600 dark:text-white dark:hover:bg-slate-500">Cancelar</button>
                <button id="save-user-changes-btn" type="submit" form="edit-user-form" class="bg-brand-blue text-white font-bold py-2 px-6 rounded-full hover:bg-brand-dark-blue transition-all">Salvar Alterações</button>
            </div>
        </div>
    </div>

    <div id="whatsapp-config-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 z-[52] flex items-center justify-center p-4 hidden opacity-0" role="dialog" aria-modal="true">
        <div class="modal-content bg-slate-50 dark:bg-slate-900 w-full max-w-4xl h-[90vh] p-0 rounded-2xl shadow-2xl scale-95 opacity-0 overflow-hidden flex flex-col">
            <div class="flex justify-between items-center p-6 border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 flex-shrink-0">
                <div class="flex items-center gap-4">
                    <i class="fab fa-whatsapp text-green-600 text-3xl"></i>
                    <div>
                        <h3 class="text-2xl font-bold text-brand-text dark:text-white">Configurar Notificações do WhatsApp</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400">Defina os números de telefone e o remetente padrão.</p>
                    </div>
                </div>
                <button id="close-whatsapp-config-modal" class="text-slate-400 hover:text-slate-800 dark:hover:text-white text-2xl">×</button>
            </div>
            <div class="p-6 flex-grow flex flex-col gap-6 overflow-y-auto">
                <form id="whatsapp-config-form" class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md flex-shrink-0 space-y-6">
                     <div>
                        <h4 class="text-xl font-bold text-brand-text dark:text-white mb-2">1. Habilitar Notificações Automáticas</h4>
                        <div class="flex items-center gap-4">
                            <label class="toggle-switch">
                                <input type="checkbox" id="notification-toggle">
                                <span class="toggle-slider"></span>
                            </label>
                            <span id="notification-toggle-label" class="font-medium text-slate-700 dark:text-slate-300">Notificações automáticas estão desativadas.</span>
                        </div>
                    </div>

                     <div>
                        <h4 class="text-xl font-bold text-brand-text dark:text-white mb-2">2. Definir Remetente Padrão</h4>
                        <label for="notification-sender-select" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Selecione o usuário cuja conta do WhatsApp enviará as notificações de falta:</label>
                        <select id="notification-sender-select" class="block w-full max-w-md rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm"></select>
                    </div>
                </form>

                <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-md flex-grow flex flex-col overflow-hidden">
                    <h4 class="text-xl font-bold text-brand-text dark:text-white mb-4 flex-shrink-0">3. Gerenciar Números de Telefone</h4>
                    <div class="table-container border dark:border-slate-700 rounded-lg flex-grow overflow-y-auto">
                         <table class="w-full text-sm text-left text-slate-700 dark:text-slate-300 rota-table">
                            <thead class="bg-slate-100 dark:bg-slate-700 sticky top-0 z-10">
                                <tr>
                                    <th>Nome do Membro</th>
                                    <th>Usuário</th>
                                    <th>Número de WhatsApp (ex: 5511999998888)</th>
                                </tr>
                            </thead>
                            <tbody id="whatsapp-numbers-table-body" class="bg-white dark:bg-slate-800">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="p-4 mt-auto bg-white dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700 flex justify-between items-center gap-3 flex-shrink-0">
                 <p id="whatsapp-config-feedback" class="text-sm font-medium h-5 transition-opacity duration-300 opacity-0"></p>
                 <button id="save-whatsapp-config-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-full hover:bg-green-700 transition-all shadow-md hover:shadow-lg">
                    <i class="fas fa-save mr-2"></i>Salvar Configurações
                </button>
            </div>
        </div>
    </div>
    
    <!-- ========== AUDIT LOG MODAL (UPDATED) ========== -->
    <div id="audit-log-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 z-[52] flex items-center justify-center p-4 hidden opacity-0" role="dialog" aria-modal="true" aria-labelledby="audit-log-modal-title">
        <div class="modal-content bg-slate-50 dark:bg-slate-900 w-full max-w-6xl h-[90vh] p-0 rounded-2xl shadow-2xl scale-95 opacity-0 overflow-hidden flex flex-col">
            <div class="flex-shrink-0 flex justify-between items-center p-6 border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800">
                <div class="flex items-center gap-4">
                    <i class="fas fa-history text-brand-blue text-3xl"></i>
                    <div>
                        <h3 id="audit-log-modal-title" class="text-2xl font-bold text-brand-text dark:text-white">Log de Rastreabilidade</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400">Histórico de ações importantes realizadas no portal.</p>
                    </div>
                </div>
                <button id="close-audit-log-modal" class="text-slate-400 hover:text-slate-800 dark:hover:text-white text-2xl">×</button>
            </div>
            <div class="p-6 flex-grow flex flex-col overflow-y-auto">
                 <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                    <div class="relative w-full md:max-w-md">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fas fa-search text-slate-400"></i>
                        </div>
                        <input type="text" id="audit-log-search" placeholder="Pesquisar em qualquer campo..." class="block w-full pl-10 pr-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md leading-5 bg-white dark:bg-slate-700 text-slate-900 dark:text-white placeholder-slate-500 dark:placeholder-slate-400 focus:outline-none focus:placeholder-slate-400 focus:ring-1 focus:ring-brand-blue focus:border-brand-blue sm:text-sm">
                    </div>
                    <button id="clear-audit-log-btn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-full hover:bg-red-700 transition-all text-sm w-full md:w-auto flex-shrink-0">
                        <i class="fas fa-trash-alt mr-2"></i>Limpar Histórico de Logs
                    </button>
                </div>
                <div class="table-container border dark:border-slate-700 rounded-lg flex-grow overflow-y-auto">
                    <table class="w-full text-sm text-left text-slate-700 dark:text-slate-300 audit-table">
                        <thead class="bg-slate-100 dark:bg-slate-700 sticky top-0 z-10">
                            <tr>
                                <th>Data/Hora</th>
                                <th>Usuário</th>
                                <th>Módulo</th>
                                <th>Ação</th>
                                <th>Detalhes</th>
                            </tr>
                        </thead>
                        <tbody id="audit-log-table-body" class="bg-white dark:bg-slate-800">
                            <!-- Logs will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="confirmation-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 z-[53] flex items-center justify-center p-4 hidden opacity-0" role="dialog" aria-modal="true">
        <div class="modal-content bg-white dark:bg-slate-800 w-full max-w-md p-6 rounded-2xl shadow-2xl text-center scale-95 opacity-0">
            <h3 id="confirmation-title" class="text-xl font-bold text-brand-text dark:text-white mb-2">Atenção!</h3>
            <p id="confirmation-message" class="text-slate-600 dark:text-slate-300 mb-6"></p>
            <div class="flex justify-center gap-4">
                 <button id="cancel-confirmation-btn" class="bg-slate-200 text-slate-800 font-bold py-2 px-8 rounded-full hover:bg-slate-300 transition-all dark:bg-slate-600 dark:text-white dark:hover:bg-slate-500">Cancelar</button>
                 <button id="confirm-action-btn" class="bg-red-600 text-white font-bold py-2 px-8 rounded-full hover:bg-red-700 transition-all">Confirmar</button>
            </div>
        </div>
    </div>


    <footer class="bg-white dark:bg-slate-800 py-12 border-t border-slate-200 dark:border-slate-700 content-hidden">
    <div class="container mx-auto px-6 text-center text-slate-500 dark:text-slate-400">
        <div class="mb-8">
            <a href="https://kvsl11.github.io/ministerio-uziel/" target="_blank" class="inline-block bg-brand-blue text-white font-semibold px-8 py-3 rounded-full hover:bg-brand-dark-blue transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-1 text-lg">
                <i class="fas fa-home mr-2"></i>
                Visite nosso Site Oficial
            </a>
        </div>

        <div class="flex justify-center space-x-6 mb-8">
            <a href="https://open.spotify.com/user/31g7w3m744kda4o4ql5cyzvq3zba" target="_blank" class="text-slate-400 hover:text-green-500 transition-colors duration-300" aria-label="Spotify"><i class="fab fa-spotify fa-2x"></i></a>
            <a href="https://www.instagram.com/oministeriouziel?igsh=MmVha2dyNm9rOW9j" target="_blank" class="text-slate-400 hover:text-pink-500 transition-colors duration-300" aria-label="Instagram"><i class="fab fa-instagram fa-2x"></i></a>
            <a href="https://www.facebook.com/share/1AWxqDPciq/" target="_blank" class="text-slate-400 hover:text-blue-600 transition-colors duration-300" aria-label="Facebook"><i class="fab fa-facebook fa-2x"></i></a>
            <a href="https://www.tiktok.com/@ministeriouziel?_t=8nrksX0puQI&_r=1" target="_blank" class="text-slate-400 hover:text-black dark:hover:text-white transition-colors duration-300" aria-label="TikTok"><i class="fab fa-tiktok fa-2x"></i></a>
            <a href="https://youtube.com/@ministeriouziel?si=k1t63Kqr67h3Xm5E" target="_blank" class="text-slate-400 hover:text-red-600 transition-colors duration-300" aria-label="YouTube"><i class="fab fa-youtube fa-2x"></i></a>
        </div>
        
        <p>© 2025 Ministério Uziel. Todos os direitos reservados.</p>
    </div>
</footer>
    
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, updateDoc, increment, getDocs, writeBatch, where, runTransaction, setDoc, deleteDoc, addDoc, getDoc, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Module-level variables
        let allMembers = [];
        let allRecords = [];
        let allRepertories = [];
        let allPlaylists = [];
        let allAuditLogs = [];
        let currentRepertoryId = null;
        let currentUser = null;
        let db;
        let appId;
        let currentEvent = null; 
        let currentDate = null;
        let userCredentials = [];
        let notificationSenderUsername = null; 
        let automaticNotificationsEnabled = true;
        const SUPER_ADMIN_USERNAME = 'kaio@uziel.com';
        
        // --- THEME SWITCHER FUNCTION ---
        function initializeThemeSwitcher() {
            const desktopToggle = document.getElementById('desktop-theme-toggle');
            const mobileToggle = document.getElementById('mobile-theme-toggle');
            const toggleButtons = [desktopToggle, mobileToggle];

            const updateToggleUI = (isDark) => {
                toggleButtons.forEach(button => {
                    if(button) {
                        const sunIcon = button.querySelector('.fa-sun');
                        const moonIcon = button.querySelector('.fa-moon');
                        if(sunIcon && moonIcon) {
                            sunIcon.classList.toggle('hidden', !isDark);
                            moonIcon.classList.toggle('hidden', isDark);
                        }
                    }
                });
            };

            const toggleTheme = () => {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.theme = isDark ? 'dark' : 'light';
                updateToggleUI(isDark);
                logAction('Tema Alterado', 'Interface', `Tema alterado para ${isDark ? 'Escuro' : 'Claro'}`);
            };

            // Set initial theme based on localStorage or system preference
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                updateToggleUI(true);
            } else {
                document.documentElement.classList.remove('dark');
                updateToggleUI(false);
            }
            
            // Add event listeners
            toggleButtons.forEach(button => {
                if(button) button.addEventListener('click', toggleTheme);
            });
        }
        
        // --- AUDIT LOG FUNCTION ---
        async function logAction(action, module, details = '') {
            if (!currentUser || !db) return;
            try {
                const logsCol = collection(db, `artifacts/${appId}/public/data/audit_logs`);
                await addDoc(logsCol, {
                    user: currentUser.name,
                    action,
                    module,
                    details,
                    timestamp: serverTimestamp()
                });
            } catch (error) {
                console.error("Erro ao registrar ação:", error);
            }
        }
        
        // --- GLOBAL HELPER FUNCTIONS ---
        function openConfirmationModal(message, onConfirm) {
            const modal = document.getElementById('confirmation-modal');
            const content = modal.querySelector('.modal-content');
            const confirmMessage = modal.querySelector('#confirmation-message');
            const confirmBtn = modal.querySelector('#confirm-action-btn');
            const cancelBtn = modal.querySelector('#cancel-confirmation-btn');

            confirmMessage.textContent = message;

            confirmBtn.onclick = () => {
                onConfirm();
                closeConfirmationModal();
            };

            cancelBtn.onclick = () => {
                closeConfirmationModal();
            };

            modal.onclick = (e) => {
                if (e.target === modal) {
                    closeConfirmationModal();
                }
            };

            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function closeConfirmationModal() {
            const modal = document.getElementById('confirmation-modal');
            const content = modal.querySelector('.modal-content');
            
            if (!modal || modal.classList.contains('hidden')) return;

            content.classList.add('scale-95', 'opacity-0');
            modal.classList.add('opacity-0');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                if (!document.querySelector('.modal-overlay.is-open')) {
                    document.body.style.overflow = '';
                }
            }, 300);
        }

        // --- LOGIN SYSTEM & USER MANAGEMENT ---
        const initialUserCredentials = [
            { username: 'kaio@uziel.com', password: '1103', name: 'KAIO VINICIUS', role: 'admin', whatsapp: '' },
            { username: 'junior@uziel.com', password: '1106', name: 'JUNIOR CAVALCANTE', role: 'admin', whatsapp: '' },
            { username: 'willian@uziel.com', password: '2206', name: 'WILLIAN FALAVINA', role: 'admin', whatsapp: '' },
            { username: 'ana@uziel.com', password: '0603', name: 'ANA BONIN', role: 'member', whatsapp: '' },
            { username: 'enio@uziel.com', password: '0501', name: 'ÊNIO HENRIQUE', role: 'member', whatsapp: '' },
            { username: 'camila@uziel.com', password: '1609', name: 'CAMILA FALAVINA', role: 'member', whatsapp: '' },
            { username: 'karla@uziel.com', password: '1510', name: 'KARLA VANESSA', role: 'member', whatsapp: '' },
            { username: 'mel@uziel.com', password: '1403', name: 'MEL BUZZO', role: 'member', whatsapp: '' },
            { username: 'alexandre@uziel.com', password: '1006', name: 'ALEXANDRE MANDELI', role: 'member', whatsapp: '' },
            { username: 'julio@uziel.com', password: '1807', name: 'JULIO CÉSAR', role: 'member', whatsapp: '' }
        ];
        
        const isSuperAdmin = (user) => user && user.username === SUPER_ADMIN_USERNAME;

        function loadUserCredentials() {
            const storedUsers = localStorage.getItem('userCredentials');
            notificationSenderUsername = localStorage.getItem('notificationSenderUsername');
            const storedNotificationSetting = localStorage.getItem('automaticNotificationsEnabled');
            automaticNotificationsEnabled = storedNotificationSetting === null ? true : JSON.parse(storedNotificationSetting);


            if (storedUsers) {
                let parsedUsers = JSON.parse(storedUsers);
                userCredentials = parsedUsers.map(u => ({ ...u, whatsapp: u.whatsapp || '' }));
            } else {
                userCredentials = initialUserCredentials;
                saveUserCredentials();
            }
        }

        function saveUserCredentials() {
            localStorage.setItem('userCredentials', JSON.stringify(userCredentials));
            if (notificationSenderUsername) {
                localStorage.setItem('notificationSenderUsername', notificationSenderUsername);
            }
            localStorage.setItem('automaticNotificationsEnabled', JSON.stringify(automaticNotificationsEnabled));
        }

        function setupModalInteraction(modalId, openBtnId, closeBtnId, onOpen) {
             const modal = document.getElementById(modalId);
             const openBtn = document.getElementById(openBtnId);
             const closeBtn = document.getElementById(closeBtnId);
             if (!modal || (!openBtn && openBtnId) || !closeBtn) return;
             const content = modal.querySelector('.modal-content');
             const openModal = () => {
                 modal.classList.remove('hidden');
                 document.body.style.overflow = 'hidden';
                 setTimeout(() => {
                     modal.classList.add('is-open');
                     modal.classList.remove('opacity-0');
                     content.classList.remove('scale-95', 'opacity-0');
                 }, 10);
                
                 // Enhanced Logging: Log when a modal is opened via a card
                 if (currentUser && openBtnId) {
                     try {
                         const openButtonElement = document.getElementById(openBtnId);
                         const cardTitle = openButtonElement?.querySelector('h3')?.textContent.trim() || openBtnId.replace(/open-|-modal|-trigger/g, ' ').trim();
                         const module = cardTitle || modalId.replace('-modal', '');
                         logAction('Abriu Ferramenta', module, `Usuário abriu o modal '${module}'.`);
                     } catch (e) {
                         console.error("Error during modal open logging:", e);
                     }
                 }
                
                 if (onOpen) onOpen();
             };
             const closeModal = () => { content.classList.add('scale-95', 'opacity-0'); modal.classList.add('opacity-0'); modal.classList.remove('is-open'); setTimeout(() => { modal.classList.add('hidden'); if (!document.querySelector('.modal-overlay.is-open')) { document.body.style.overflow = ''; } }, 300); };
             if (openBtn) { openBtn.addEventListener('click', openModal); }
             closeBtn.addEventListener('click', closeModal);
             modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
             return closeModal;
        }

        function initializeUserManagement() {
            // **FIX**: The `onOpen` callback now only populates data, doesn't add new listeners.
            setupModalInteraction('user-management-modal', 'open-user-management-modal', 'close-user-management-modal', populateUsersTable);
            setupModalInteraction('edit-user-modal', null, 'close-edit-user-modal');

            const createUserForm = document.getElementById('create-user-form');
            const createUserError = document.getElementById('create-user-error');
            const usersTableBody = document.getElementById('users-table-body');
            const editUserModal = document.getElementById('edit-user-modal');
            
            function openEditUserModal(username) {
                const user = userCredentials.find(u => u.username === username);
                if (!user || !editUserModal || !currentUser) return;

                const loggedInUserIsSuperAdmin = isSuperAdmin(currentUser);
                const userToEditIsAdmin = user.role === 'admin';

                if (!loggedInUserIsSuperAdmin && userToEditIsAdmin) {
                    console.warn("Permission denied: Cannot edit another admin.");
                    return;
                }
                
                editUserModal.querySelector('#edit-user-original-username').value = user.username;
                editUserModal.querySelector('#edit-user-name').value = user.name;
                editUserModal.querySelector('#edit-user-username-display').value = user.username;
                
                const roleSelect = editUserModal.querySelector('#edit-user-role');
                const passwordInput = editUserModal.querySelector('#edit-user-password');
                
                roleSelect.value = user.role;
                passwordInput.value = '';
                editUserModal.querySelector('#edit-user-error').textContent = '';

                const canChangeRole = loggedInUserIsSuperAdmin || !userToEditIsAdmin;
                roleSelect.disabled = !canChangeRole;

                const canChangePassword = loggedInUserIsSuperAdmin || !userToEditIsAdmin;
                passwordInput.parentElement.style.display = canChangePassword ? 'block' : 'none';
                
                if (loggedInUserIsSuperAdmin) {
                    passwordInput.setAttribute('placeholder', `Senha atual: ${user.password}`);
                } else {
                    passwordInput.setAttribute('placeholder', '••••••••');
                }


                editUserModal.classList.remove('hidden');
                setTimeout(() => { editUserModal.classList.remove('opacity-0'); editUserModal.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0'); }, 10);
            }

            function closeEditUserModal() {
                 if(!editUserModal) return;
                 const content = editUserModal.querySelector('.modal-content');
                 content.classList.add('scale-95', 'opacity-0');
                 editUserModal.classList.add('opacity-0');
                 setTimeout(() => editUserModal.classList.add('hidden'), 300);
            }

            document.getElementById('cancel-edit-user-btn')?.addEventListener('click', closeEditUserModal);

            document.getElementById('edit-user-form')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const originalUsername = form.querySelector('#edit-user-original-username').value;
                const newName = form.querySelector('#edit-user-name').value.toUpperCase().trim();
                const newRole = form.querySelector('#edit-user-role').value;
                const newPassword = form.querySelector('#edit-user-password').value;
                const errorEl = form.querySelector('#edit-user-error');
                errorEl.textContent = '';
                
                const userToEditIndex = userCredentials.findIndex(u => u.username === originalUsername);
                if (userToEditIndex === -1) {
                    errorEl.textContent = 'Usuário não encontrado.';
                    return;
                }
                
                const userToEdit = userCredentials[userToEditIndex];
                const loggedInUserIsSuperAdmin = isSuperAdmin(currentUser);
                const userToEditIsAdmin = userToEdit.role === 'admin';

                if (!loggedInUserIsSuperAdmin && userToEditIsAdmin) {
                    errorEl.textContent = "Não tem permissão para editar um administrador.";
                    return;
                }

                if (!newName) {
                    errorEl.textContent = 'O nome não pode estar vazio.';
                    return;
                }

                const originalName = userCredentials[userToEditIndex].name;
                userCredentials[userToEditIndex].name = newName;
                userCredentials[userToEditIndex].role = newRole;
                if (newPassword.trim() !== '') {
                    userCredentials[userToEditIndex].password = newPassword.trim();
                }

                saveUserCredentials();
                logAction('Usuário Atualizado', 'Gestão de Usuários', `Detalhes atualizados para ${newName}`);
                
                if (originalName !== newName) {
                    try {
                        const membersCol = collection(db, `artifacts/${appId}/public/data/members`);
                        const q = query(membersCol, where("name", "==", originalName));
                        const querySnapshot = await getDocs(q);
                        if (!querySnapshot.empty) {
                            const memberDocRef = querySnapshot.docs[0].ref;
                            await updateDoc(memberDocRef, { name: newName });
                        }
                    } catch (error) {
                        console.error("Erro ao atualizar o nome do membro no Firestore:", error);
                    }
                }
                
                populateUsersTable();
                closeEditUserModal();
            });

            createUserForm?.addEventListener('submit', async (e) => {
                e.preventDefault();
                createUserError.textContent = '';
                const name = document.getElementById('new-user-name').value.toUpperCase().trim();
                const usernamePrefix = document.getElementById('new-user-username').value.toLowerCase().trim();
                const password = document.getElementById('new-user-password').value;
                const role = document.getElementById('new-user-role').value;
                if (!name || !usernamePrefix || !password) { createUserError.textContent = 'Todos os campos são obrigatórios.'; return; }
                const username = `${usernamePrefix}@uziel.com`;
                if (userCredentials.some(u => u.username === username)) { createUserError.textContent = 'Este usuário já existe.'; return; }
                const newUser = { name, username, password, role, whatsapp: '' };
                userCredentials.push(newUser);
                saveUserCredentials();
                logAction('Usuário Criado', 'Gestão de Usuários', `Usuário criado: ${name} (${username})`);
                try {
                    const membersCol = collection(db, `artifacts/${appId}/public/data/members`);
                    await addDoc(membersCol, { name: name, totalPoints: 0 });
                } catch (error) { console.error("Erro ao adicionar membro ao Firestore: ", error); }
                createUserForm.reset();
                populateUsersTable();
            });

            usersTableBody?.addEventListener('click', (e) => {
                const target = e.target;
                if (target.matches('.delete-user-btn')) {
                    const usernameToDelete = target.dataset.username;
                    const userToDelete = userCredentials.find(u => u.username === usernameToDelete);
                    if (userToDelete) {
                        openConfirmationModal(`Tem a certeza que deseja excluir ${userToDelete.name}? Esta ação irá remover também todo o seu histórico de presenças e é irreversível.`,
                            async () => {
                                userCredentials = userCredentials.filter(u => u.username !== usernameToDelete);
                                saveUserCredentials();
                                logAction('Usuário Excluído', 'Gestão de Usuários', `Usuário excluído: ${userToDelete.name} (${userToDelete.username})`);
                                try {
                                    const membersCol = collection(db, `artifacts/${appId}/public/data/members`);
                                    const attendanceCol = collection(db, `artifacts/${appId}/public/data/attendance`);
                                    const memberQuery = query(membersCol, where("name", "==", userToDelete.name));
                                    const memberSnapshot = await getDocs(memberQuery);
                                    if (!memberSnapshot.empty) {
                                        const memberDoc = memberSnapshot.docs[0];
                                        const memberId = memberDoc.id;
                                        const batch = writeBatch(db);
                                        const attendanceQuery = query(attendanceCol, where("memberId", "==", memberId));
                                        const attendanceSnapshot = await getDocs(attendanceQuery);
                                        attendanceSnapshot.forEach(doc => batch.delete(doc.ref));
                                        batch.delete(memberDoc.ref);
                                        await batch.commit();
                                    }
                                } catch (error) { console.error("Erro ao excluir usuário do Firestore: ", error); }
                                populateUsersTable();
                            }
                        );
                    }
                } else if (target.matches('.edit-user-btn')) {
                    openEditUserModal(target.dataset.username);
                }
            });
        }
        
        function populateUsersTable() {
            const usersTableBody = document.getElementById('users-table-body');
            if (!usersTableBody || !currentUser) return;
            usersTableBody.innerHTML = '';

            const loggedInUserIsSuperAdmin = isSuperAdmin(currentUser);

            userCredentials.forEach(user => {
                const userInRowIsAdmin = user.role === 'admin';
                const userInRowIsSelf = user.username === currentUser.username;
                
                const canEdit = loggedInUserIsSuperAdmin || !userInRowIsAdmin;
                const canDelete = !userInRowIsSelf && (loggedInUserIsSuperAdmin || !userInRowIsAdmin);

                const editButton = `<button data-username="${user.username}" class="edit-user-btn text-sm font-semibold ${canEdit ? 'text-blue-500 hover:text-blue-700' : 'text-slate-400 cursor-not-allowed'}" ${!canEdit ? 'disabled' : ''}>Editar</button>`;
                const deleteButton = `<button data-username="${user.username}" class="delete-user-btn text-sm font-semibold ${canDelete ? 'text-red-500 hover:text-red-700' : 'text-slate-400 cursor-not-allowed'}" ${!canDelete ? 'disabled' : ''}>Excluir</button>`;
                
                usersTableBody.innerHTML += `
                    <tr class="hover:bg-slate-50 dark:hover:bg-slate-700">
                        <td class="p-3">${user.name}</td>
                        <td class="p-3">${user.username}</td>
                        <td class="p-3"><span class="px-2 py-1 text-xs font-semibold rounded-full ${user.role === 'admin' ? 'bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200' : 'bg-slate-100 text-slate-800 dark:bg-slate-600 dark:text-slate-200'}">${user.role}</span></td>
                        <td class="p-3 flex gap-4">
                            ${editButton}
                            ${deleteButton}
                        </td>
                    </tr>
                `;
            });
        }

        // --- Main Execution Logic on DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', async () => {
            
            // Firebase Initialization
            try {
                const fallbackConfig = { apiKey: "AIzaSyASN-L5S6-KexN4OtKUOUrGDU1JaMuVsMY", authDomain: "forms-d0559.firebaseapp.com", projectId: "forms-d0559", storageBucket: "forms-d0559.appspot.com", messagingSenderId: "494787147690", appId: "1:494787147690:web:b2a4f4b4e85e76df929dd3", measurementId: "G-TJT2CRB34L" };
                const firebaseConfigStr = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
                let firebaseConfig = JSON.parse(firebaseConfigStr);
                if (!firebaseConfig.apiKey) { firebaseConfig = fallbackConfig; }
                appId = typeof __app_id !== 'undefined' ? __app_id : 'portal-uziel-v1-fallback';
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                const auth = getAuth(app);
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { await signInWithCustomToken(auth, __initial_auth_token); } else { await signInAnonymously(auth); }
                onAuthStateChanged(auth, (user) => { if (user) { initializeDataListeners(); } });
            } catch (error) { console.error("Error initializing Firebase:", error); }

            // Other initializations
            const observer = new IntersectionObserver((entries) => { entries.forEach(entry => { if (entry.isIntersecting) { entry.target.classList.add('visible'); } }); }, { threshold: 0.1 });
            document.querySelectorAll('.reveal').forEach(el => observer.observe(el));
            const header = document.getElementById('header');
            const handleHeaderScroll = () => {
                if (!currentUser) return;
                const scrolled = window.scrollY > 10;
                header.classList.toggle('header-scrolled', scrolled);
                header.classList.toggle('bg-white/90', scrolled);
                header.classList.toggle('dark:bg-slate-900/90', scrolled);
                header.classList.toggle('backdrop-blur-sm', scrolled);
                header.querySelector('h1').classList.toggle('text-white', !scrolled);
                header.querySelector('h1').classList.toggle('text-brand-blue', scrolled);
                header.querySelector('p').classList.toggle('text-slate-300', !scrolled);
                header.querySelector('p').classList.toggle('text-gray-500', scrolled);
                header.querySelector('p').classList.toggle('dark:text-slate-400', scrolled);

                const mobileButton = document.getElementById('mobile-menu-button');
                mobileButton.classList.toggle('text-white', !scrolled);
                mobileButton.classList.toggle('text-brand-text', scrolled);
                mobileButton.classList.toggle('dark:text-white', scrolled);

                const mobileThemeButton = document.getElementById('mobile-theme-toggle');
                mobileThemeButton.classList.toggle('text-white', !scrolled);
                mobileThemeButton.classList.toggle('text-brand-text', scrolled);
                mobileThemeButton.classList.toggle('dark:text-white', scrolled);

                header.querySelectorAll('nav.hidden a:not(#header-cta-btn)').forEach(link => {
                    link.classList.toggle('text-slate-200', !scrolled);
                    link.classList.toggle('hover:text-white', !scrolled);
                    link.classList.toggle('text-slate-600', scrolled);
                    link.classList.toggle('hover:text-brand-blue', scrolled);
                    link.classList.toggle('dark:text-slate-300', scrolled);
                    link.classList.toggle('dark:hover:text-white', scrolled);
                });
                
                const desktopThemeButton = document.getElementById('desktop-theme-toggle');
                desktopThemeButton.classList.toggle('text-slate-200', !scrolled);
                desktopThemeButton.classList.toggle('hover:text-white', !scrolled);
                desktopThemeButton.classList.toggle('text-slate-600', scrolled);
                desktopThemeButton.classList.toggle('hover:text-brand-blue', scrolled);
                desktopThemeButton.classList.toggle('dark:text-slate-300', scrolled);
                desktopThemeButton.classList.toggle('dark:hover:text-white', scrolled);
            };
            window.addEventListener('scroll', handleHeaderScroll);
            const mobileMenu = document.getElementById('mobile-menu');
            const toggleMenu = () => {
                const isOpen = document.body.classList.toggle('menu-open');
                document.body.style.overflow = isOpen ? 'hidden' : '';
                document.getElementById('menu-open-icon').classList.toggle('hidden', isOpen);
                document.getElementById('menu-close-icon').classList.toggle('hidden', !isOpen);
                if (isOpen) { mobileMenu.classList.remove('pointer-events-none', 'opacity-0'); } 
                else { mobileMenu.classList.add('opacity-0'); setTimeout(() => mobileMenu.classList.add('pointer-events-none'), 300); }
            };
            document.getElementById('mobile-menu-button').addEventListener('click', toggleMenu);
            document.querySelectorAll('.mobile-nav-link').forEach(link => link.addEventListener('click', () => { if(document.body.classList.contains('menu-open')) { toggleMenu(); } }));
            const filterContainer = document.getElementById('category-filters');
            if (filterContainer) { filterContainer.addEventListener('click', (e) => { const target = e.target.closest('button'); if (!target) return; const category = target.dataset.category; filterContainer.querySelector('.active').classList.remove('active'); target.classList.add('active'); document.querySelectorAll('.portal-card-wrapper').forEach(card => card.classList.toggle('filtered-out', !(category === 'all' || card.dataset.category === category))); setTimeout(() => document.getElementById('portal').scrollIntoView({ behavior: 'smooth' }), 100); });}
            
            setupModalInteraction('statute-modal', 'open-statute-modal', 'close-statute-modal');
            document.addEventListener('keydown', (event) => { if (event.key === 'Escape') { const openModals = document.querySelectorAll('.modal-overlay.is-open'); if (openModals.length > 0) { const topModal = openModals[openModals.length - 1]; const closeButton = topModal.querySelector('[id^="close-"]'); if (closeButton) closeButton.click(); } } });
            
            updateHourlyVerse();
            setInterval(updateHourlyVerse, 3600000);

            // Rota Logic
            setupModalInteraction('rota-modal', 'open-rota-modal', 'close-rota-modal', () => {
                const regenerateBtn = document.getElementById('regenerate-rota-btn');
                if (currentUser && currentUser.role === 'admin') { regenerateBtn.classList.remove('hidden'); } else { regenerateBtn.classList.add('hidden'); }
                generateAndDisplayRota(false);
            });
            document.getElementById('regenerate-rota-btn')?.addEventListener('click', () => {
                generateAndDisplayRota(true);
                logAction('Nova Escala Gerada', 'Salmistas', 'Forçou a geração aleatória');
            });
            
            // Generator Logic with Role-Based Access
            // **FIX:** A função onOpen agora chama renderRepertoryHistory() para carregar os dados.
            setupModalInteraction('pptx-generator-modal', 'open-pptx-generator-modal', 'close-pptx-generator-modal', () => {
                populateSongTypeSelector();
                setupGeneratorModalForUser();
                renderRepertoryHistory(); // CORREÇÃO: Renderiza o histórico sempre que o modal é aberto.
            });
                                      
            // Playlist Logic
            setupModalInteraction('playlist-modal', 'open-playlist-modal', 'close-playlist-modal', () => {
                renderPlaylistModal();
            });
            
            // Audit Log Logic (UPDATED & CORRECTED)
            setupModalInteraction('audit-log-modal', 'open-audit-log-modal', 'close-audit-log-modal', () => {
                const searchInput = document.getElementById('audit-log-search');
                const clearButton = document.getElementById('clear-audit-log-btn');

                renderAuditLog(); // Renderiza a tabela de logs

                // Garante que o listener de busca seja adicionado apenas uma vez
                if (searchInput && !searchInput.hasAttribute('data-listener-attached')) {
                    searchInput.addEventListener('input', renderAuditLog);
                    searchInput.setAttribute('data-listener-attached', 'true');
                }

                // **CORREÇÃO:** Adiciona o listener para o botão de limpar sempre que o modal abrir
                // Isso garante que o botão funcionará corretamente.
                if (clearButton && !clearButton.hasAttribute('data-listener-attached')) {
                    clearButton.addEventListener('click', clearAuditLog);
                    clearButton.setAttribute('data-listener-attached', 'true');
                }
            });
            document.getElementById('clear-form-btn')?.addEventListener('click', () => clearRepertoryForm());

            // Enhanced Logging for External Link Cards
            addLoggingToLinkCards();

            // Login System
            loadUserCredentials();
            const mainLoginForm = document.getElementById('main-login-form');
            const mainLoginError = document.getElementById('main-login-error');
            const mainLoginOverlay = document.getElementById('main-login-overlay');
            const contentElements = document.querySelectorAll('main, footer, header'); // Corrected selector
            const headerCtaBtn = document.getElementById('header-cta-btn');
            const mobileHeaderCtaBtn = document.getElementById('mobile-header-cta-btn');
            const userManagementCard = document.getElementById('user-management-card-wrapper');
            const whatsappConfigCard = document.getElementById('whatsapp-config-card-wrapper');
            const auditLogCard = document.getElementById('audit-log-card-wrapper');
            
            function setLoggedInState(user) {
                currentUser = user;
                mainLoginOverlay.classList.add('hidden');
                contentElements.forEach(el => el.classList.remove('content-hidden'));
                
                if (user.role === 'admin') {
                    userManagementCard.classList.remove('hidden', 'filtered-out');
                    populateUsersTable(); // Re-populate table on login
                } else {
                     userManagementCard.classList.add('hidden', 'filtered-out');
                }

                if (isSuperAdmin(user)) {
                    whatsappConfigCard.classList.remove('hidden', 'filtered-out');
                    initializeWhatsAppConfig();
                    auditLogCard.classList.remove('hidden', 'filtered-out');
                } else {
                    whatsappConfigCard.classList.add('hidden', 'filtered-out');
                    auditLogCard.classList.add('hidden', 'filtered-out');
                }
                
                headerCtaBtn.textContent = 'Sair';
                headerCtaBtn.href = '#';
                headerCtaBtn.removeAttribute('target');
                mobileHeaderCtaBtn.textContent = 'Sair';
                mobileHeaderCtaBtn.href = '#';
                mobileHeaderCtaBtn.removeAttribute('target');
                
                const logoutAction = (evt) => { evt.preventDefault(); logout(); };
                headerCtaBtn.onclick = logoutAction;
                mobileHeaderCtaBtn.onclick = logoutAction;

                handleHeaderScroll();
            }

            function logout() {
                localStorage.removeItem('currentUser');
                currentUser = null;
                
                mainLoginOverlay.classList.remove('hidden');
                contentElements.forEach(el => {
                    if (!el.classList.contains('content-hidden')) {
                        el.classList.add('content-hidden');
                    }
                });
                userManagementCard.classList.add('hidden');
                whatsappConfigCard.classList.add('hidden');
                auditLogCard.classList.add('hidden');

                
                headerCtaBtn.textContent = 'Seja Membro';
                headerCtaBtn.href = 'https://docs.google.com/forms/d/1VF8dLdhjZnqK4_K2r_-ELXhV1frXMRdSZF-ORHR-TZA/edit?usp=drivesdk';
                headerCtaBtn.setAttribute('target', '_blank');
                headerCtaBtn.onclick = null;
                
                mobileHeaderCtaBtn.textContent = 'Seja Membro';
                mobileHeaderCtaBtn.href = 'https://docs.google.com/forms/d/1VF8dLdhjZnqK4_K2r_-ELXhV1frXMRdSZF-ORHR-TZA/edit?usp=drivesdk';
                mobileHeaderCtaBtn.setAttribute('target', '_blank');
                mobileHeaderCtaBtn.onclick = null;
                window.location.reload();
            }

            const savedUserJSON = localStorage.getItem('currentUser');
            if (savedUserJSON) {
                const savedUser = JSON.parse(savedUserJSON);
                setLoggedInState(savedUser);
            } else {
                mainLoginOverlay.classList.remove('hidden');
            }

            mainLoginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                mainLoginError.textContent = '';
                const usernameInput = mainLoginForm['main-username'].value.trim().toLowerCase();
                const username = usernameInput.includes('@') ? usernameInput : `${usernameInput}@uziel.com`;
                const password = mainLoginForm['main-password'].value;
                const user = userCredentials.find(u => u.username === username && u.password === password);

                if (user) {
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    setLoggedInState(user);
                    logAction('Login', 'Autenticação', `Usuário ${user.name} entrou.`);
                    mainLoginForm.reset();
                } else {
                    mainLoginError.textContent = 'Usuário ou senha inválidos.';
                }
            });

             // --- Attendance Modal Logic ---
             document.getElementById('open-attendance-trigger').addEventListener('click', () => { 
                 if(currentUser) { 
                     logAction('Abriu Ferramenta', 'Controle de Presença', `Usuário abriu o modal de Controle de Presença.`);
                     openAttendanceModal(); 
                 } 
             });
             setupModalInteraction('attendance-modal', null, 'close-attendance-modal');

            // **FIX**: Initialize all major component listeners ONCE.
            initializeThemeSwitcher();
            initializeUserManagement();
            initializeGeneratorEventListeners();
            initializePlaylistSystem();
        });
        
        // --- ALL OTHER FUNCTIONS ---
        
        // NEW function to re-render the attendance modal if it's visible
        function updateAttendanceViewIfVisible() {
            const attendanceModal = document.getElementById('attendance-modal');
            if (attendanceModal && attendanceModal.classList.contains('is-open')) {
                renderAttendanceUI();
            }
        }

        function initializeDataListeners() {
            if (!db || !appId) { console.error("Firebase não foi inicializado."); return; }

            // Members Listener
            const membersCol = collection(db, `artifacts/${appId}/public/data/members`);
            onSnapshot(query(membersCol), (snapshot) => {
                allMembers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allMembers.sort((a, b) => a.name.localeCompare(b.name));
                updateAttendanceViewIfVisible(); // UPDATE UI on change
            }, (error) => { console.error("Erro ao buscar membros: ", error); });

            // Attendance Listener
            const attendanceCol = collection(db, `artifacts/${appId}/public/data/attendance`);
            onSnapshot(query(attendanceCol), (snapshot) => {
                allRecords = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allRecords.sort((a, b) => (b.date || "").localeCompare(a.date || "") || (b.createdAt || "").localeCompare(a.createdAt || ""));
                updateAttendanceViewIfVisible(); // UPDATE UI on change
            }, (error) => { console.error("Erro ao buscar registros de presença: ", error); });

            // Repertory Listener
            const repertoryCol = collection(db, `artifacts/${appId}/public/data/repertory`);
            onSnapshot(query(repertoryCol, orderBy("date", "desc")), (snapshot) => {
                allRepertories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (document.getElementById('pptx-generator-modal').classList.contains('is-open')) {
                    renderRepertoryHistory();
                }
            });

            // Playlist Listener
            const playlistsCol = collection(db, `artifacts/${appId}/public/data/playlists`);
            onSnapshot(query(playlistsCol, orderBy("createdAt", "desc")), (snapshot) => {
                allPlaylists = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (document.getElementById('playlist-modal').classList.contains('is-open')) {
                    renderPlaylistModal();
                }
            });
            
            // Audit Log Listener
            const auditLogsCol = collection(db, `artifacts/${appId}/public/data/audit_logs`);
            onSnapshot(query(auditLogsCol, orderBy("timestamp", "desc")), (snapshot) => {
                allAuditLogs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if(document.getElementById('audit-log-modal').classList.contains('is-open')) {
                    renderAuditLog();
                }
            });
        }

        // NEW: Enhanced logging for external link cards
        function addLoggingToLinkCards() {
            const cardGrid = document.getElementById('card-grid');
            if (!cardGrid) return;

            const linkCards = cardGrid.querySelectorAll('.portal-card-wrapper > a.portal-card');
            
            linkCards.forEach(card => {
                card.addEventListener('click', () => {
                    if (!currentUser) return; 

                    const titleEl = card.querySelector('h3');
                    const moduleName = titleEl ? titleEl.textContent.trim() : 'Link Externo';
                    
                    const details = `Redirecionado para ${card.href}.`;
                    logAction('Acesso a Link Externo', moduleName, details);
                });
            });
        }


        function updateHourlyVerse() { const verses = [ { text: "Porque Deus amou o mundo de tal maneira que deu o seu Filho unigênito, para que todo aquele que nele crê não pereça, mas tenha a vida eterna.", reference: "João 3:16" }, { text: "O Senhor é o meu pastor; nada me faltará.", reference: "Salmos 23:1" }, { text: "Posso todas as coisas em Cristo que me fortalece.", reference: "Filipenses 4:13" }]; const seededRandom = (seed) => { const x = Math.sin(seed) * 10000; return x - Math.floor(x); }; const now = new Date(); const seed = now.getFullYear() * 10000 + (now.getMonth() + 1) * 100 + now.getDate() * 24 + now.getHours(); const randomIndex = Math.floor(seededRandom(seed) * verses.length); const verse = verses[randomIndex]; if (verse) { document.getElementById('verse-text').textContent = verse.text; document.getElementById('verse-reference').textContent = verse.reference; } }
        function generateAndDisplayRota(forceRandom = false) { const rotaLoading = document.getElementById('rota-loading'); const rotaContent = document.getElementById('rota-content'); const rotaTableBody = document.getElementById('rota-table-body'); rotaLoading.style.display = 'block'; rotaContent.style.display = 'none'; const salmistasSource = ["ANA BONIN", "ÊNIO HENRIQUE", "WILLIAN FALAVINA", "CAMILA FALAVINA", "JUNIOR CAVALCANTE", "KARLA VANESSA", "KAIO VINICIUS"]; if (!salmistasSource || salmistasSource.length < 2) { rotaTableBody.innerHTML = '<tr><td colspan="3" class="text-center p-4">São necessários ao menos 2 salmistas.</td></tr>'; rotaLoading.style.display = 'none'; rotaContent.style.display = 'block'; return; } setTimeout(() => { const now = new Date(); let baseSeed; if (forceRandom) { baseSeed = Math.random() * 100000; } else { const startYear = now.getFullYear(); const startMonth = now.getMonth(); baseSeed = startYear * 100 + startMonth; } const seededShuffle = (array, seed) => { let m = array.length, t, i; const random = () => { var x = Math.sin(seed++) * 10000; return x - Math.floor(x); }; while (m) { i = Math.floor(random() * m--); t = array[m]; array[m] = array[i]; array[i] = t; } return array; }; const yearlySalmistaOrder = seededShuffle([...salmistasSource], baseSeed); const yearlySubstitutoOrder = seededShuffle([...salmistasSource], baseSeed + 1); let salmistaIndex = 0; let substitutoIndex = 0; rotaTableBody.innerHTML = ''; for (let i = 0; i < 12; i++) { let salmista, substituto; while (true) { salmista = yearlySalmistaOrder[salmistaIndex % yearlySalmistaOrder.length]; substituto = yearlySubstitutoOrder[substitutoIndex % yearlySubstitutoOrder.length]; if (salmista !== substituto) { salmistaIndex++; substitutoIndex++; break; } else { substitutoIndex++; } } const targetDate = new Date(now.getFullYear(), now.getMonth() + i, 1); const dateOfFirstSunday = (7 - targetDate.getDay()) % 7 + 1; targetDate.setDate(dateOfFirstSunday); const isCurrent = targetDate.getMonth() === now.getMonth() && targetDate.getFullYear() === now.getFullYear(); rotaTableBody.innerHTML += `<tr class="${isCurrent ? 'current-month' : ''}"><td>${targetDate.toLocaleDateString('pt-BR', { timeZone: 'UTC', day: '2-digit', month: 'long', year: 'numeric' })}</td><td class="font-semibold text-brand-dark-blue">${salmista}</td><td>${substituto}</td></tr>`; } rotaLoading.style.display = 'none'; rotaContent.style.display = 'block'; }, 50); }
        function showGeneratorFeedback(message, isError = true, duration = 4000) { const el = document.getElementById('generator-feedback'); if (!el) return; el.textContent = message; el.classList.toggle('text-red-600', isError); el.classList.toggle('text-green-600', !isError); el.classList.remove('opacity-0'); if (duration > 0) { setTimeout(() => el.classList.add('opacity-0'), duration); } }

        // --- PLAYLIST LOGIC (NEW / MODERNIZED) ---
        // **FIX**: This function is now called only once on page load.
        function initializePlaylistSystem() {
            const addPlaylistForm = document.getElementById('add-playlist-form');
            addPlaylistForm?.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser || currentUser.role !== 'admin') return;

                const urlInput = document.getElementById('new-playlist-url');
                const feedbackEl = document.getElementById('playlist-form-feedback');
                const url = urlInput.value.trim();

                if (!url) {
                    feedbackEl.textContent = 'Por favor, insira um URL.';
                    return;
                }
                
                if (!url.includes('spotify.com') && !url.includes('youtube.com') && !url.includes('youtu.be')) {
                    feedbackEl.textContent = 'URL inválido. Use um link do Spotify ou YouTube.';
                     setTimeout(() => feedbackEl.textContent = '', 3000);
                    return;
                }

                try {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/playlists`), {
                        url: url,
                        addedBy: currentUser.name,
                        createdAt: serverTimestamp() 
                    });
                    logAction('Playlist Adicionada', 'Playlists', `URL: ${url}`);
                    urlInput.value = '';
                    feedbackEl.textContent = '';
                } catch (error) {
                    console.error("Erro ao adicionar playlist: ", error);
                    feedbackEl.textContent = 'Erro ao salvar a playlist.';
                }
            });
        }
        
        function renderPlaylistModal() {
            const listContainer = document.getElementById('playlist-list-container');
            const embedContainer = document.getElementById('playlist-embed-container');
            const addPlaylistForm = document.getElementById('add-playlist-form');

            if (!listContainer || !currentUser) return;

            addPlaylistForm.classList.toggle('hidden', currentUser.role !== 'admin');

            if (allPlaylists.length === 0) {
                listContainer.innerHTML = `<div class="text-center text-slate-500 dark:text-slate-400 py-8"><i class="fas fa-compact-disc fa-2x mb-3"></i><p>Nenhuma playlist foi adicionada ainda.</p></div>`;
                return;
            }

            listContainer.innerHTML = allPlaylists.map(playlist => {
                const url = new URL(playlist.url);
                const hostname = url.hostname.replace('www.', '');

                let iconClass = 'fa-link';
                if (hostname.includes('spotify')) iconClass = 'fa-spotify text-green-500';
                if (hostname.includes('youtube') || hostname.includes('youtu.be')) iconClass = 'fa-youtube text-red-500';

                const adminDeleteButton = currentUser.role === 'admin' ? 
                    `<button data-id="${playlist.id}" data-url="${playlist.url}" class="delete-playlist-btn text-slate-400 hover:text-red-500 transition-colors ml-auto"><i class="fas fa-trash-alt"></i></button>` : '';

                return `
                    <div id="playlist-item-${playlist.id}" class="playlist-item-container flex items-center gap-3">
                        <button data-url="${playlist.url}" class="view-playlist-btn w-full text-left p-3 rounded-lg border dark:border-slate-700 bg-white dark:bg-slate-800 flex items-center gap-3 playlist-item">
                            <i class="fab ${iconClass} fa-lg w-5 text-center"></i>
                            <span class="flex-grow text-sm font-semibold text-slate-700 dark:text-slate-200 truncate">${hostname}</span>
                            <i class="fas fa-chevron-right text-slate-400"></i>
                        </button>
                        ${adminDeleteButton}
                    </div>
                `;
            }).join('');
            
            listContainer.querySelectorAll('.view-playlist-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const url = e.currentTarget.dataset.url;
                    embedContainer.innerHTML = getEmbedHtml(url, true); 
                    
                    document.querySelectorAll('.playlist-item').forEach(item => item.classList.remove('active'));
                    e.currentTarget.classList.add('active');

                    // Enhanced Logging: Log when a user views a playlist embed
                    if (currentUser) {
                        logAction('Visualizou Playlist', 'Playlists', `Visualizou a playlist/vídeo no link: ${url}`);
                    }
                });
            });

            if (currentUser.role === 'admin') {
                listContainer.querySelectorAll('.delete-playlist-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const playlistId = e.currentTarget.dataset.id;
                        const playlistUrl = e.currentTarget.dataset.url;
                        openConfirmationModal(
                            'Tem certeza que deseja excluir esta playlist?',
                            () => deletePlaylist(playlistId, playlistUrl)
                        );
                    });
                });
            }
        }
        
        async function deletePlaylist(playlistId, playlistUrl) {
            if (!currentUser || currentUser.role !== 'admin' || !db) return;
            try {
                const playlistRef = doc(db, `artifacts/${appId}/public/data/playlists`, playlistId);
                await deleteDoc(playlistRef);
                logAction('Playlist Excluída', 'Playlists', `URL: ${playlistUrl}`);
            } catch (error) {
                console.error("Erro ao excluir playlist:", error);
                alert('Ocorreu um erro ao excluir a playlist.');
            }
        }

        /**
         * **FIX**: Changed YouTube embed URL to youtube-nocookie.com to fix embedding issues.
         */
        function getEmbedHtml(url, isModern = false) {
            // Se não houver URL, retorna uma mensagem padrão.
            if (!url) {
                return `<p class="text-sm text-center text-slate-400 italic mt-4">${isModern ? 'Selecione uma playlist para visualizar' : 'Nenhum player de mídia adicionado.'}</p>`;
            }

            // Obtém a origem da página para usar no URL de embed, o que ajuda na verificação pelo YouTube.
            const origin = window.location.origin;

            // Tenta identificar uma playlist do YouTube no URL.
            const ytPlaylistMatch = url.match(/[?&]list=([a-zA-Z0-9_-]+)/);
            if (ytPlaylistMatch && ytPlaylistMatch[1]) {
                const playlistId = ytPlaylistMatch[1];
                // CORREÇÃO: Usa o URL de embed padrão com o parâmetro 'origin'.
                const embedUrl = `https://www.youtube.com/embed/videoseries?list=${playlistId}&enablejsapi=1&origin=${origin}`;
                return `<div class="aspect-w-16 aspect-h-9 w-full h-full relative" style="padding-bottom: 56.25%; height: 0;"><iframe src="${embedUrl}" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen class="absolute top-0 left-0 w-full h-full rounded-lg shadow-lg"></iframe></div>`;
            }

            // Tenta identificar um vídeo individual do YouTube (incluindo formatos como /watch, /embed, /shorts/).
            const ytVideoMatch = url.match(/(?:youtube\.com\/(?:watch\?v=|embed\/|v\/|shorts\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
            if (ytVideoMatch && ytVideoMatch[1]) {
                const videoId = ytVideoMatch[1];
                // CORREÇÃO: Usa o URL de embed padrão com o parâmetro 'origin'.
                const embedUrl = `https://www.youtube.com/embed/${videoId}?enablejsapi=1&origin=${origin}`;
                return `<div class="aspect-w-16 aspect-h-9 w-full h-full relative" style="padding-bottom: 56.25%; height: 0;"><iframe src="${embedUrl}" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen class="absolute top-0 left-0 w-full h-full rounded-lg shadow-lg"></iframe></div>`;
            }

            // Tenta identificar um link do Spotify (faixa, playlist ou álbum).
            const spotifyMatch = url.match(/https?:\/\/open\.spotify\.com\/(?:[a-zA-Z0-9\-_]+\/)?(track|playlist|album)\/([a-zA-Z0-9]{22})/);
            if (spotifyMatch && spotifyMatch[1] && spotifyMatch[2]) {
                const type = spotifyMatch[1];
                const id = spotifyMatch[2];
                const height = isModern ? '100%' : '352';
                const themeParam = document.documentElement.classList.contains('dark') ? '&theme=0' : '';
                const spotifyUri = `https://open.spotify.com/embed/${type}/${id}?utm_source=generator${themeParam}`;
                return `<iframe style="border-radius:12px" src="${spotifyUri}" width="100%" height="${height}" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy" class="${isModern ? '' : 'mt-4 shadow-lg'}"></iframe>`;
            }
            
            // Se nenhum formato for reconhecido, retorna um link genérico.
            return `<div class="mt-4 text-center"><a href="${url}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 bg-slate-500 text-white font-semibold py-1.5 px-3 rounded-full text-sm hover:bg-slate-600 transition-colors"><i class="fas fa-link"></i>Acessar Link Externo</a></div>`;
        }
        // --- FILE GENERATOR LOGIC (PPTX & PDF) ---
        // *** START: DYNAMIC REPERTORY REFACTOR ***

        const songFields = [
            { id: 'antes-da-missa', title: 'Antes da Missa' }, { id: 'entrada', title: 'Entrada' }, { id: 'entrada-especial', title: 'Entradas Especiais' },
            { id: 'perdao', title: 'Ato Penitencial' }, { id: 'gloria', title: 'Glória' }, { id: 'salmo', title: 'Salmo Responsorial' },
            { id: 'aclamacao', title: 'Aclamação ao Evangelho' }, { id: 'ofertorio', title: 'Ofertório' }, { id: 'santo', title: 'Santo' },
            { id: 'comunhao', title: 'Comunhão' }, { id: 'final', title: 'Final' }, { id: 'adoracao', title: 'Adoração' },
        ];
        
        let songFieldCounter = 0;

        function populateSongTypeSelector() {
         const selector = document.getElementById('song-type-selector');
         if (!selector) return;
         selector.innerHTML = songFields
             .map(field => `<option value="${field.title}">${field.title}</option>`)
             .join('') + '<option value="custom">Outro (Personalizado)...</option>'; // <-- ALTERAÇÃO AQUI
     }

        function createSongFieldHTML(title, lyrics = '', link = '') {
            songFieldCounter++;
            const uniqueId = `song-${songFieldCounter}`;
            
            const isAdmin = currentUser && currentUser.role === 'admin';

            return `
            <div class="dynamic-song-card bg-white dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-700" data-song-title="${title}">
                <div class="flex justify-between items-center mb-3">
                    <h5 class="font-bold text-brand-text dark:text-white flex items-center gap-2"><i class="fas fa-music text-slate-400"></i>${title}</h5>
                    <button type="button" class="remove-song-btn text-red-500 hover:text-red-700 font-semibold admin-only-input" ${!isAdmin ? 'disabled' : ''}>
                        <i class="fas fa-times-circle mr-1"></i>Remover
                    </button>
                </div>
                <div class="space-y-4">
                    <div>
                        <label for="lyrics-${uniqueId}" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Letra</label>
                        <textarea id="lyrics-${uniqueId}" rows="4" class="lyrics-input admin-only-input mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm" ${!isAdmin ? 'disabled' : ''}>${lyrics}</textarea>
                    </div>
                    <div>
                        <label for="link-${uniqueId}" class="block text-sm font-medium text-slate-500 dark:text-slate-400">Link (YouTube/Spotify)</label>
                        <input type="url" id="link-${uniqueId}" value="${link}" class="link-input admin-only-input mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm text-sm" placeholder="https://..." ${!isAdmin ? 'disabled' : ''}>
                    </div>
                </div>
            </div>
            `;
        }
        
        // **SUBSTITUA TODA A FUNÇÃO** com este código atualizado
     function initializeGeneratorEventListeners() {
         
         // --- LÓGICA ATUALIZADA PARA O BOTÃO "ADICIONAR" ---
         document.getElementById('add-song-btn')?.addEventListener('click', () => {
             const selector = document.getElementById('song-type-selector');
             const customInput = document.getElementById('custom-song-type-input');
             if (!selector || !customInput) return;

             let songType = selector.value;

             // Se a opção for 'custom', pega o valor do campo de texto
             if (songType === 'custom') {
                 songType = customInput.value.trim();
                 if (!songType) {
                     showGeneratorFeedback("Por favor, digite um nome para o cântico personalizado.", true);
                     return;
                 }
             }
             
             // Adiciona o cântico ao formulário
             const container = document.getElementById('dynamic-song-fields-container');
             container.insertAdjacentHTML('beforeend', createSongFieldHTML(songType));

             // Reseta a interface de seleção para o estado inicial
             const selectorWrapper = document.getElementById('song-type-selector-wrapper');
             const customInputWrapper = document.getElementById('custom-song-type-wrapper');
             selector.value = songFields[0]?.title || ''; // Volta para a primeira opção da lista
             selectorWrapper.classList.remove('hidden');
             customInputWrapper.classList.add('hidden');
             customInput.value = '';
         });

         // --- NOVO CÓDIGO PARA CONTROLAR A VISIBILIDADE DO CAMPO PERSONALIZADO ---
         const songTypeSelector = document.getElementById('song-type-selector');
         if (songTypeSelector) {
             songTypeSelector.addEventListener('change', () => {
                 const customInputWrapper = document.getElementById('custom-song-type-wrapper');
                 const selectorWrapper = document.getElementById('song-type-selector-wrapper');
                 if (songTypeSelector.value === 'custom') {
                     selectorWrapper.classList.add('hidden'); // Esconde o seletor
                     customInputWrapper.classList.remove('hidden'); // Mostra o campo de texto
                     document.getElementById('custom-song-type-input').focus();
                 } else {
                     selectorWrapper.classList.remove('hidden'); // Garante que o seletor está visível
                     customInputWrapper.classList.add('hidden'); // Esconde o campo de texto
                 }
             });
         }

         // --- CÓDIGO ORIGINAL DA FUNÇÃO (MANTIDO) ---
         document.getElementById('dynamic-song-fields-container')?.addEventListener('click', (e) => {
             const removeBtn = e.target.closest('.remove-song-btn');
             if (removeBtn) {
                 removeBtn.closest('.dynamic-song-card').remove();
             }
         });

         document.getElementById('save-repertory-btn')?.addEventListener('click', saveRepertory);
         document.getElementById('clear-repertory-history-btn')?.addEventListener('click', clearAllRepertories);
         document.getElementById('generate-pptx-btn')?.addEventListener('click', generatePptx);
         document.getElementById('generate-pdf-btn')?.addEventListener('click', generatePdf);
         
         const tabsContainer = document.getElementById('generator-tabs');
         tabsContainer?.addEventListener('click', (e) => {
             const targetButton = e.target.closest('.generator-tab-btn');
             if (!targetButton) return;
             
             const tabName = targetButton.dataset.tab;

             if (tabName === 'visualizar' && targetButton.classList.contains('hidden')) {
                 return; 
             }
             
             tabsContainer.querySelectorAll('.generator-tab-btn').forEach(btn => btn.classList.remove('active'));
             targetButton.classList.add('active');
             
             document.querySelectorAll('.generator-tab-pane').forEach(pane => {
                 pane.classList.toggle('hidden', pane.id !== `tab-${tabName}`);
             });
         });

         const historyContentDiv = document.getElementById('repertory-history-content');
         historyContentDiv?.addEventListener('click', (e) => {
             const target = e.target;
             if (target.closest('.edit-repertory-btn')) {
                 loadRepertoryForEditing(target.closest('.edit-repertory-btn').dataset.id);
             } else if (target.closest('.view-repertory-btn')) {
                 loadRepertoryForViewing(target.closest('.view-repertory-btn').dataset.id);
             } else if (target.closest('.delete-repertory-btn')) {
                 deleteRepertory(target.closest('.delete-repertory-btn').dataset.id);
             }
         });
     }
        
        function getSongDataFromForm() {
            const form = document.getElementById('pptx-form');
            const songCards = document.querySelectorAll('#dynamic-song-fields-container .dynamic-song-card');
            
            const songs = Array.from(songCards).map((card, index) => {
                const title = card.dataset.songTitle;
                const lyrics = card.querySelector('.lyrics-input').value.trim();
                const link = card.querySelector('.link-input').value.trim();
                return {
                    id: `${title.toLowerCase().replace(/[^a-z0-9]/g, '-')}-${index}`, // Create a simple unique ID
                    title: title,
                    lyrics: lyrics,
                    link: link
                };
            });

            const dateInput = document.getElementById('mass-date').value;
            const theme = document.getElementById('mass-theme').value.trim();
            const id = document.getElementById('repertory-id').value;
            
            return { id, songs, theme, date: dateInput };
        }

        function clearRepertoryForm() {
            document.getElementById('pptx-form').reset();
            document.getElementById('repertory-id').value = '';
            document.getElementById('mass-date').value = new Date().toISOString().split('T')[0];
            
            const container = document.getElementById('dynamic-song-fields-container');
            if (container) container.innerHTML = '';
            songFieldCounter = 0; // Reset counter

            const viewTabBtn = document.querySelector('[data-tab="visualizar"]');
            if (viewTabBtn) {
                viewTabBtn.classList.add('hidden');
            }
            document.querySelector('[data-tab="montar"]').click();
        }
        
        // *** END: DYNAMIC REPERTORY REFACTOR ***
        
        function setGeneratorButtonsLoading(isLoading) {
            const buttons = ['generate-pptx-btn', 'generate-pdf-btn', 'save-repertory-btn', 'clear-form-btn', 'clear-repertory-history-btn'];
            buttons.forEach(btnId => {
                const button = document.getElementById(btnId);
                if (!button) return;
                button.disabled = isLoading;
                const icon = button.querySelector('i');
                if (isLoading) {
                    if (icon) icon.className = 'fas fa-spinner fa-spin mr-2';
                } else {
                     if (icon) {
                         const originalIcons = { 
                             'generate-pptx-btn': 'fa-file-powerpoint', 
                             'generate-pdf-btn': 'fa-file-pdf', 
                             'save-repertory-btn': 'fa-save',
                             'clear-form-btn': 'fa-undo',
                             'clear-repertory-history-btn': 'fa-trash-alt'
                         };
                        icon.className = `fas ${originalIcons[btnId]} mr-2`;
                         }
                }
            });
        }
        
        function setupGeneratorModalForUser() {
            const isAdmin = currentUser && currentUser.role === 'admin';
            const modal = document.getElementById('pptx-generator-modal');
            if (!modal) return;
            
            const montarTabBtn = modal.querySelector('[data-tab="montar"]');
            const actions = modal.querySelector('#generator-actions');
            const formInputs = modal.querySelectorAll('.admin-only-input');
            const historicoTabBtn = modal.querySelector('[data-tab="historico"]');
            const clearHistoryBtn = document.getElementById('clear-repertory-history-btn');

            if (clearHistoryBtn) {
                clearHistoryBtn.style.display = isAdmin ? '' : 'none';
            }
            
            if (isAdmin) {
                montarTabBtn.classList.remove('hidden');
                actions.classList.remove('hidden');
                formInputs.forEach(input => input.disabled = false);
                clearRepertoryForm(); 
                montarTabBtn.click();
            } else {
                montarTabBtn.classList.add('hidden');
                actions.classList.add('hidden');
                formInputs.forEach(input => input.disabled = true);
                historicoTabBtn.click();
            }
        }
        
        async function saveRepertory() {
            if (!currentUser || currentUser.role !== 'admin' || !db) return;

            const dataToSave = getSongDataFromForm();
            if (!dataToSave.date) {
                showGeneratorFeedback("A data da missa é obrigatória para salvar.", true);
                return;
            }
            
            setGeneratorButtonsLoading(true);
            showGeneratorFeedback("Salvando repertório...", false, 0);

            const repertoryId = dataToSave.id;
            const isUpdating = !!repertoryId;
            delete dataToSave.id;

            const repertoryCol = collection(db, `artifacts/${appId}/public/data/repertory`);
            let savedId = repertoryId;

            try {
                const action = isUpdating ? 'Repertório Atualizado' : 'Repertório Criado';
                const details = `${dataToSave.theme || 'Repertório'} de ${dataToSave.date}`;

                if (isUpdating) {
                    const repertoryRef = doc(repertoryCol, repertoryId);
                    await updateDoc(repertoryRef, dataToSave);
                    showGeneratorFeedback("Repertório atualizado com sucesso!", false);
                } else {
                    const newDocRef = await addDoc(repertoryCol, dataToSave);
                    savedId = newDocRef.id;
                    // **FIX**: Updated feedback to guide user on creating a new repertory.
                    showGeneratorFeedback("Salvo! Clique em 'Novo' para criar outro.", false, 6000);
                }
                logAction(action, 'Gerador de Repertório', details);
                loadRepertoryForViewing(savedId);
            } catch (error) {
                console.error("Erro ao salvar repertório: ", error);
                showGeneratorFeedback("Erro ao salvar o repertório.", true);
            } finally {
                setGeneratorButtonsLoading(false);
            }
        }
        
        async function clearAllRepertories() {
            if (!currentUser || currentUser.role !== 'admin') return;

            openConfirmationModal(
                "Tem certeza que deseja apagar TODO o histórico de repertórios? Esta ação é irreversível.",
                async () => {
                    setGeneratorButtonsLoading(true);
                    showGeneratorFeedback("Limpando histórico...", false, 0);
                    try {
                        const repertoryCol = collection(db, `artifacts/${appId}/public/data/repertory`);
                        const snapshot = await getDocs(repertoryCol);
                        const batch = writeBatch(db);
                        snapshot.docs.forEach(doc => batch.delete(doc.ref));
                        await batch.commit();
                        logAction('Limpou Histórico de Repertórios', 'Gerador de Repertório');
                        showGeneratorFeedback("Histórico de repertórios limpo com sucesso.", false);
                    } catch (error) {
                        console.error("Error clearing repertory history: ", error);
                        showGeneratorFeedback("Erro ao limpar o histórico.", true);
                    } finally {
                        setGeneratorButtonsLoading(false);
                    }
                }
            );
        }

        function renderRepertoryHistory() {
            const contentDiv = document.getElementById('repertory-history-content');
            if (!contentDiv) return;

            if (allRepertories.length === 0) {
                contentDiv.innerHTML = `<div class="text-center text-slate-500 dark:text-slate-400 py-10"><i class="fas fa-history fa-2x mb-3"></i><p>Nenhum repertório salvo encontrado.</p></div>`;
                return;
            }

            const isAdmin = currentUser && currentUser.role === 'admin';

            contentDiv.innerHTML = allRepertories.map(rep => {
                const formattedDate = rep.date ? new Date(rep.date + 'T00:00:00').toLocaleDateString('pt-BR', { timeZone: 'UTC', day: '2-digit', month: 'short', year: 'numeric'}) : 'Sem data';
                const title = rep.theme || `Celebração de ${formattedDate}`;
                
                const adminButtons = `
                    <button data-id="${rep.id}" class="edit-repertory-btn bg-slate-100 text-slate-700 font-semibold py-1.5 px-3 rounded-full hover:bg-slate-200 dark:bg-slate-700 dark:text-slate-200 dark:hover:bg-slate-600 text-xs">Editar</button>
                    <button data-id="${rep.id}" class="delete-repertory-btn text-red-500 hover:text-red-700 text-lg"><i class="fas fa-trash-alt"></i></button>
                `;

                return `
                    <div class="bg-white dark:bg-slate-800 p-4 rounded-lg border border-slate-200 dark:border-slate-700 flex items-center justify-between gap-4">
                        <div>
                            <p class="font-bold text-brand-text dark:text-white">${title}</p>
                            <p class="text-sm text-slate-500 dark:text-slate-400">${formattedDate}</p>
                        </div>
                        <div class="flex items-center gap-2">
                             <button data-id="${rep.id}" class="view-repertory-btn bg-sky-100 text-sky-700 font-semibold py-1.5 px-3 rounded-full hover:bg-sky-200 dark:bg-sky-900 dark:text-sky-300 dark:hover:bg-sky-800 text-xs">Visualizar</button>
                             ${isAdmin ? adminButtons : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            // Note: Listeners are now attached once in initializeGeneratorEventListeners
        }

        function loadRepertoryForEditing(repertoryId) {
            const repertory = allRepertories.find(r => r.id === repertoryId);
            if (!repertory) return;

            clearRepertoryForm();

            const form = document.getElementById('pptx-form');
            form['mass-date'].value = repertory.date || '';
            form['mass-theme'].value = repertory.theme || '';
            document.getElementById('repertory-id').value = repertoryId;
            const container = document.getElementById('dynamic-song-fields-container');

            if (repertory.songs && container) {
                repertory.songs.forEach(song => {
                    container.insertAdjacentHTML('beforeend', createSongFieldHTML(song.title, song.lyrics, song.link));
                });
            }
            
            document.querySelector('[data-tab="montar"]').click();
            showGeneratorFeedback(`Repertório "${repertory.theme || repertory.date}" carregado para edição.`, false);
        }
        
        function loadRepertoryForViewing(repertoryId) {
            const repertory = allRepertories.find(r => r.id === repertoryId);
            if (!repertory) {
                console.error("Repertório não encontrado para visualização:", repertoryId);
                const formData = getSongDataFromForm();
                if(formData.date) {
                    renderSingleRepertoryView(formData);
                } else {
                    return;
                }
            } else {
                loadRepertoryForEditing(repertoryId); 
                
                renderSingleRepertoryView(repertory);
            }
            
            const viewTabBtn = document.querySelector('[data-tab="visualizar"]');
            viewTabBtn.classList.remove('hidden');
            viewTabBtn.click();
        }

        function renderSingleRepertoryView(repertoryData) {
            const contentDiv = document.getElementById('tab-visualizar');
            if (!contentDiv) return;

            const { songs, theme, date } = repertoryData;
            const songsWithContent = songs ? songs.filter(s => s.lyrics || s.link) : [];

            if (songsWithContent.length === 0) {
                contentDiv.innerHTML = `<div class="text-center text-slate-500 dark:text-slate-400 py-10"><i class="fas fa-music fa-2x mb-3"></i><p>Este repertório está vazio.</p></div>`;
                return;
            }

            const formattedDate = date ? new Date(date + 'T00:00:00').toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric'}) : '';

            let html = `<div class="text-center mb-6">
                            <h3 class="text-2xl font-bold text-brand-text dark:text-white">Repertório da Celebração</h3>
                            <p class="text-brand-blue font-semibold">${theme || formattedDate}</p>
                        </div>
                        <div id="repertory-accordion" class="space-y-3">`;

            songsWithContent.forEach((song) => {
                const embedHtml = getEmbedHtml(song.link);
                html += `
                    <div class="accordion-item bg-white dark:bg-slate-800 rounded-lg border border-slate-200 dark:border-slate-700 overflow-hidden">
                        <button class="accordion-header w-full flex justify-between items-center text-left p-4 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors focus:outline-none">
                            <span class="font-bold text-lg text-brand-text dark:text-white">${song.title}</span>
                            <i class="fas fa-chevron-down transition-transform text-slate-500 dark:text-slate-400"></i>
                        </button>
                        <div class="accordion-content">
                           <div class="p-4 border-t border-slate-200 dark:border-slate-600">
                               <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                                   <div class="lyrics-container">
                                       <h5 class="font-semibold text-slate-500 dark:text-slate-400 mb-2 text-center">Letra</h5>
                                       <pre class="text-slate-700 dark:text-slate-300 whitespace-pre-wrap font-sans text-base leading-relaxed text-center">${song.lyrics || 'Letra não disponível.'}</pre>
                                   </div>
                                   <div class="player-container">
                                        <h5 class="font-semibold text-slate-500 dark:text-slate-400 mb-2 text-center">Mídia</h5>
                                       ${embedHtml}
                                   </div>
                               </div>
                           </div>
                        </div>
                    </div>`;
            });

            html += `</div>`;
            contentDiv.innerHTML = html;
            
            contentDiv.querySelectorAll('.accordion-header').forEach(button => {
                button.addEventListener('click', () => {
                    const content = button.nextElementSibling;
                    button.classList.toggle('active');
                    if (content.style.maxHeight) {
                        content.style.maxHeight = null;
                        content.style.paddingTop = '0';
                        content.style.paddingBottom = '0';
                    } else {
                        content.style.paddingTop = '1rem';
                        content.style.paddingBottom = '1rem';
                        content.style.maxHeight = content.scrollHeight + "px";
                    }
                });
            });
        }


        function deleteRepertory(repertoryId) {
            // 1. Verifica se o usuário atual tem permissão de administrador. Se não, a função é interrompida.
            if (!currentUser || currentUser.role !== 'admin') return;

            // 2. Abre um modal de confirmação para garantir que o usuário realmente deseja excluir o item.
            openConfirmationModal(
                "Tem certeza que deseja excluir este repertório? Esta ação não pode ser desfeita.",
                async () => {
                    // 3. O código dentro desta função só é executado se o usuário clicar em "Confirmar".
                    showGeneratorFeedback("Excluindo...", false, 0); // Mostra uma mensagem de "Excluindo..."

                    try {
                        // 4. Prepara a referência para o documento específico no banco de dados (Firestore).
                        const repertoryRef = doc(db, `artifacts/${appId}/public/data/repertory`, repertoryId);
                        const repertoryToDelete = allRepertories.find(r => r.id === repertoryId);

                        // 5. Executa o comando para excluir o documento do banco de dados.
                        await deleteDoc(repertoryRef);

                        // 6. Registra a ação de exclusão no log de auditoria para rastreabilidade.
                        logAction('Repertório Excluído', 'Gerador de Repertório', `Excluído: ${repertoryToDelete.theme || repertoryToDelete.date}`);

                        // 7. Mostra uma mensagem de sucesso para o usuário.
                        showGeneratorFeedback("Repertório excluído.", false);

                        // **CORREÇÃO:** Nenhuma ação de redirecionamento é chamada aqui.
                        // O sistema (listener onSnapshot) irá detectar a mudança no banco de dados e
                        // removerá automaticamente o item da lista na aba "Histórico", 
                        // mantendo o usuário na mesma tela.

                    } catch (error) {
                        // 8. Se ocorrer qualquer erro durante o processo, ele é capturado aqui.
                        console.error("Erro ao excluir repertório: ", error); // Mostra o erro no console do navegador para depuração.
                        showGeneratorFeedback("Erro ao excluir repertório.", true); // Mostra uma mensagem de erro vermelha para o usuário.
                    }
                }
            );
        }

        async function generatePptx() {
            setGeneratorButtonsLoading(true);
            showGeneratorFeedback('Gerando PPTX, por favor aguarde...', false, 0);

            try {
                const { songs, theme, date } = getSongDataFromForm();
                const songsWithLyrics = songs.filter(s => s.lyrics);

                if (songsWithLyrics.length === 0) {
                    showGeneratorFeedback('Nenhum cântico preenchido para gerar o PPTX.', true);
                    setGeneratorButtonsLoading(false);
                    return;
                }

                let pptx = new PptxGenJS();
                const formattedDate = date ? new Date(date + 'T00:00:00').toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric'}) : '';
                
                pptx.defineLayout({ name: 'SONG_LAYOUT', width: 16, height: 9 });
                pptx.defineSlideMaster({
                    title: 'SONG_MASTER',
                    background: { color: '000000' },
                    objects: [
                        { 'text': { text: 'Ministério Uziel', options: { x: 0.5, y: 8.2, w: '90%', fontFace: 'Poppins', fontSize: 14, color: 'FFFFFF', align: 'left', opacity: 0.7 } } },
                        { 'text': { text: formattedDate, options: { x: 0.5, y: 8.2, w: '90%', fontFace: 'Poppins', fontSize: 14, color: 'FFFFFF', align: 'right', opacity: 0.7 } } },
                    ],
                });

                let titleSlide = pptx.addSlide({ masterName: 'SONG_MASTER' });
                titleSlide.addText('Cânticos da Celebração', { y: '40%', w: '100%', h: 1, align: 'center', fontFace: 'Poppins', fontSize: 44, color: 'FFFFFF', bold: true });
                if(theme) {
                     titleSlide.addText(theme, { y: '55%', w: '100%', h: 1, align: 'center', fontFace: 'Poppins', fontSize: 32, color: '29aae2' });
                }

                const linesPerSlide = 5;

                songsWithLyrics.forEach(song => {
                    const allLines = song.lyrics.split('\n').filter(line => line.trim() !== '');
                    if (allLines.length === 0) return;

                    const totalChunks = Math.ceil(allLines.length / linesPerSlide);

                    for (let i = 0; i < allLines.length; i += linesPerSlide) {
                        const chunk = allLines.slice(i, i + linesPerSlide);
                        const slideLyrics = chunk.join('\n');
                        const currentChunkIndex = (i / linesPerSlide) + 1;

                        let slide = pptx.addSlide({ masterName: 'SONG_MASTER' });

                        let slideTitle = song.title.toUpperCase();
                        if (totalChunks > 1) {
                            slideTitle += ` (${currentChunkIndex}/${totalChunks})`;
                        }
                        
                        slide.addText(slideTitle, { 
                            x: 0, y: 0.3, w: '100%', h: 1, 
                            align: 'center',
                            fontFace: 'Poppins', fontSize: 28, color: '29aae2', bold: true 
                        });
                        
                        slide.addText(slideLyrics, { 
                            x: 0.5, y: 1.5, w: '90%', h: 3.0, 
                            fontFace: 'Poppins', fontSize: 32, 
                            color: 'FFFFFF', 
                            align: 'center',
                            valign: 'middle',
                            lineSpacing: 40,
                            bold: true
                        });
                    }
                });

                const fileNameDate = date || 'data';
                const filename = `Canticos_Uziel_${theme.replace(/\s+/g, '_') || fileNameDate}.pptx`;
                await pptx.writeFile({ fileName: filename });
                showGeneratorFeedback('PPTX gerado com sucesso!', false);

            } catch (error) {
                console.error("Erro ao gerar PPTX:", error);
                showGeneratorFeedback('Ocorreu um erro ao gerar o PPTX.', true);
            } finally {
                setGeneratorButtonsLoading(false);
            }
        }
        
        function generatePdf() {
            setGeneratorButtonsLoading(true);
            showGeneratorFeedback('Gerando PDF, por favor aguarde...', false, 0);

            try {
                const { songs, theme, date } = getSongDataFromForm();
                const songsWithLyrics = songs.filter(s => s.lyrics);

                 if (songsWithLyrics.length === 0) {
                        showGeneratorFeedback('Nenhum cântico preenchido para gerar o PDF.', true);
                        setGeneratorButtonsLoading(false);
                        return;
                }
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'p', unit: 'pt', format: 'a4' });
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 40;
                const formattedDate = date ? new Date(date + 'T00:00:00').toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric'}) : '';

                const addHeaderFooter = (docInstance) => {
                    const pageCount = docInstance.internal.getNumberOfPages();
                    for (let i = 1; i <= pageCount; i++) {
                        docInstance.setPage(i);
                        docInstance.setFontSize(9);
                        docInstance.setTextColor(150);
                        docInstance.text('Ministério Uziel', margin, margin - 10);
                        docInstance.text(formattedDate, pageWidth - margin, margin - 10, { align: 'right' });
                        docInstance.text(`Página ${i} de ${pageCount}`, pageWidth / 2, pageHeight - (margin / 2), { align: 'center' });
                    }
                };
                
                let y = margin + 20;

                doc.setFont('helvetica', 'bold');
                doc.setFontSize(22);
                doc.setTextColor('#334155');
                doc.text('Roteiro de Cânticos', pageWidth / 2, y, { align: 'center' });
                y += 30;
                
                if (theme) {
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(16);
                    doc.setTextColor('#29aae2');
                    doc.text(theme, pageWidth / 2, y, { align: 'center' });
                    y += 30;
                }
                
                y += 10;
                
                songsWithLyrics.forEach((song, index) => {
                    const titleHeight = 30; 
                    const oneLineHeight = 15;
                    const requiredSpaceForTitleAndFirstLine = titleHeight + oneLineHeight;

                    if (y + requiredSpaceForTitleAndFirstLine > pageHeight - margin) {
                          doc.addPage();
                          y = margin + 20;
                    } else {
                        if(y > margin + 21) y += 30;
                    }

                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(14);
                    doc.setTextColor('#29aae2');
                    doc.text(song.title.toUpperCase(), pageWidth / 2, y, { align: 'center' });
                    y += 25;

                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(12);
                    doc.setTextColor('#334155');
                    const splitLyrics = doc.splitTextToSize(song.lyrics, pageWidth - (margin * 2));
                    
                    splitLyrics.forEach(line => {
                        if (y > pageHeight - margin) {
                            doc.addPage();
                            y = margin + 20;
                        }
                        doc.text(line, pageWidth / 2, y, { align: 'center' });
                        y += 15;
                    });
                });

                addHeaderFooter(doc);
                const fileNameDate = date || 'data';
                const filename = `Roteiro_Uziel_${theme.replace(/\s+/g, '_') || fileNameDate}.pdf`;
                doc.save(filename);
                showGeneratorFeedback('PDF gerado com sucesso!', false);

            } catch(error) {
                console.error("Erro ao gerar PDF:", error);
                showGeneratorFeedback('Ocorreu um erro ao gerar o PDF.', true);
            } finally {
                setGeneratorButtonsLoading(false);
            }
        }
        
        // --- WHATSAPP NOTIFICATION LOGIC ---
        function initializeWhatsAppConfig() {
            setupModalInteraction('whatsapp-config-modal', 'open-whatsapp-config-modal', 'close-whatsapp-config-modal', populateWhatsAppConfigModal);
            
            const saveBtn = document.getElementById('save-whatsapp-config-btn');
            saveBtn?.addEventListener('click', saveWhatsAppConfig);
        }

        function populateWhatsAppConfigModal() {
            const senderSelect = document.getElementById('notification-sender-select');
            const tableBody = document.getElementById('whatsapp-numbers-table-body');
            const toggle = document.getElementById('notification-toggle');
            const toggleLabel = document.getElementById('notification-toggle-label');
            
            if (!senderSelect || !tableBody || !toggle || !toggleLabel) return;
            
            // Set toggle state
            toggle.checked = automaticNotificationsEnabled;
            toggleLabel.textContent = automaticNotificationsEnabled ? 'Notificações automáticas estão ativadas.' : 'Notificações automáticas estão desativadas.';

            toggle.onchange = () => {
                 automaticNotificationsEnabled = toggle.checked;
                 toggleLabel.textContent = automaticNotificationsEnabled ? 'Notificações automáticas estão ativadas.' : 'Notificações automáticas estão desativadas.';
            };
            
            senderSelect.innerHTML = '<option value="">-- Selecione um Remetente --</option>';
            tableBody.innerHTML = '';

            userCredentials.forEach(user => {
                senderSelect.innerHTML += `<option value="${user.username}">${user.name}</option>`;
                tableBody.innerHTML += `
                    <tr>
                        <td class="font-semibold">${user.name}</td>
                        <td>${user.username}</td>
                        <td>
                            <input type="tel" 
                                   data-username="${user.username}" 
                                   class="whatsapp-number-input mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm" 
                                   placeholder="55119..." 
                                   value="${user.whatsapp || ''}">
                        </td>
                    </tr>
                `;
            });

            if (notificationSenderUsername) {
                senderSelect.value = notificationSenderUsername;
            }
        }
        
        function saveWhatsAppConfig() {
            const feedbackEl = document.getElementById('whatsapp-config-feedback');
            try {
                const senderSelect = document.getElementById('notification-sender-select');
                notificationSenderUsername = senderSelect.value;
                
                automaticNotificationsEnabled = document.getElementById('notification-toggle').checked;

                document.querySelectorAll('.whatsapp-number-input').forEach(input => {
                    const username = input.dataset.username;
                    const userIndex = userCredentials.findIndex(u => u.username === username);
                    if (userIndex > -1) {
                        userCredentials[userIndex].whatsapp = input.value.replace(/\D/g, '');
                    }
                });

                saveUserCredentials();
                logAction('Config. do WhatsApp Salva', 'Notificações do WhatsApp');
                
                feedbackEl.textContent = 'Configurações salvas com sucesso!';
                feedbackEl.className = 'text-green-600 text-sm font-medium h-5 transition-opacity duration-300 opacity-100';
            } catch (error) {
                console.error("Erro ao salvar config. do WhatsApp:", error);
                feedbackEl.textContent = 'Erro ao salvar configurações.';
                feedbackEl.className = 'text-red-600 text-sm font-medium h-5 transition-opacity duration-300 opacity-100';
            } finally {
                setTimeout(() => { feedbackEl.classList.add('opacity-0'); }, 3000);
            }
        }

        function triggerWhatsAppNotification(absentMemberName, eventType, eventDate, justification) {
            if (!automaticNotificationsEnabled) {
                console.log("Notificação não enviada: O envio automático está desativado pelo Super Admin.");
                return;
            }

            if (!currentUser || currentUser.role !== 'admin') {
                console.warn("Notificação não enviada: Apenas administradores podem enviar notificações.");
                return;
            }

            const sender = userCredentials.find(u => u.username === notificationSenderUsername);
            const recipient = userCredentials.find(u => u.name === absentMemberName);

            if (!sender || !sender.whatsapp) {
                console.warn('Remetente do WhatsApp não configurado ou sem número.');
                alert("Aviso: Remetente do WhatsApp não configurado na área de administração. A notificação não pode ser enviada.");
                return;
            }
            if (!recipient || !recipient.whatsapp) {
                console.warn(`Membro ${absentMemberName} não possui número de WhatsApp cadastrado.`);
                alert(`Aviso: O membro ${absentMemberName} não possui um número de WhatsApp cadastrado. A notificação não pode ser enviada.`);
                return;
            }

            const formattedDate = new Date(eventDate + 'T00:00:00').toLocaleDateString('pt-BR', {timeZone: 'UTC'});
            const justificationText = justification ? `Justificativa: "${justification}"` : "Falta sem justificativa.";

            const message = `Olá, ${recipient.name.split(' ')[0]}! Paz e bem.

Este é um aviso automático do Portal do Ministério Uziel.
Foi registrada uma falta para você no evento *${eventType}* do dia *${formattedDate}*.

Status: ${justificationText}

Qualquer dúvida, por favor, entre em contato com a liderança.
Deus abençoe!`;

            const whatsappUrl = `https://wa.me/${recipient.whatsapp}?text=${encodeURIComponent(message)}`;
            
            window.open(whatsappUrl, '_blank');
        }


        // --- ATTENDANCE AND SCORING SYSTEM LOGIC ---
        function openAttendanceModal() {
            const modal = document.getElementById('attendance-modal');
            const content = modal.querySelector('.modal-content');
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            setTimeout(() => { modal.classList.add('is-open'); modal.classList.remove('opacity-0'); content.classList.remove('scale-95', 'opacity-0'); }, 10);
            renderAttendanceUI();
        }

        function renderAttendanceUI() {
            const attendanceContentArea = document.getElementById('attendance-content-area');
            if (!currentUser) { attendanceContentArea.innerHTML = ''; return; }
            if (currentUser.role === 'admin') { renderAdminView(attendanceContentArea); } else { renderMemberView(attendanceContentArea); }
        }

        function renderAdminView(container) {
            // 1. CAPTURA o estado da aba ativa ANTES de recarregar o HTML.
            const activeTabName = container.querySelector('.attendance-tab-button.active')?.dataset.tab || 'dashboard';
            // 2. RECONSTRÓI TODO O HTML
            container.innerHTML = `
                <div class="flex flex-col h-full">
                    <div id="attendance-tabs" class="p-6 border-b border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 flex-shrink-0">
                        <nav class="flex flex-wrap items-center justify-center gap-2 bg-slate-100 dark:bg-slate-800 p-2 rounded-full shadow-inner">
                            <button data-tab="dashboard" class="attendance-tab-button px-6 py-2 text-sm font-semibold rounded-full flex items-center gap-2 transition-colors duration-200">
                                <i class="fas fa-chart-line"></i><span>Dashboard</span>
                            </button>
                            <button data-tab="setup" class="attendance-tab-button px-6 py-2 text-sm font-semibold rounded-full flex items-center gap-2 transition-colors duration-200">
                                <i class="fas fa-cog"></i><span>Configurar Evento</span>
                            </button>
                            <button data-tab="register" class="attendance-tab-button px-6 py-2 text-sm font-semibold rounded-full flex items-center gap-2 transition-colors duration-200">
                                <i class="fas fa-user-check"></i><span>Registrar Presença</span>
                            </button>
                            <button data-tab="records" class="attendance-tab-button px-6 py-2 text-sm font-semibold rounded-full flex items-center gap-2 transition-colors duration-200">
                                <i class="fas fa-history"></i><span>Visualizar Registros</span>
                            </button>
                        </nav>
                    </div>
                    <div id="tab-content-container" class="p-6 flex-grow overflow-y-auto">
                        <div id="tab-dashboard" class="tab-pane">
                            <div class="dashboard-container">
                                <h4 class="text-xl font-bold text-brand-text dark:text-white mb-4">Dashboard de Participação</h4>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                    <div class="bg-white dark:bg-slate-800 p-4 rounded-lg text-center shadow-md">
                                        <h5 class="text-sm font-semibold text-blue-800 dark:text-blue-300 uppercase">Total de Presenças</h5>
                                        <p id="stat-total-presence" class="text-3xl font-bold text-blue-600">0</p>
                                    </div>
                                    <div class="bg-white dark:bg-slate-800 p-4 rounded-lg text-center shadow-md">
                                        <h5 class="text-sm font-semibold text-red-800 dark:text-red-300 uppercase">Total de Faltas</h5>
                                        <p id="stat-total-absence" class="text-3xl font-bold text-red-600">0</p>
                                    </div>
                                    <div class="bg-white dark:bg-slate-800 p-4 rounded-lg text-center shadow-md">
                                        <h5 class="text-sm font-semibold text-green-800 dark:text-green-300 uppercase">Taxa de Presença</h5>
                                        <p id="stat-presence-rate" class="text-3xl font-bold text-green-600">0%</p>
                                    </div>
                                </div>
                                <h4 class="text-xl font-bold text-brand-text dark:text-white mb-4 mt-8">Ranking de Pontuação (Faltas)</h4>
                                <table class="w-full text-sm text-slate-700 dark:text-slate-300 rota-table">
                                    <thead class="sticky top-0 bg-slate-100 dark:bg-slate-700 z-10">
                                        <tr><th>Posição</th><th>Membro</th><th>Pontos de Falta</th></tr>
                                    </thead>
                                    <tbody id="member-ranking-body" class="bg-white dark:bg-slate-800"></tbody>
                                </table>
                            </div>
                        </div>
                        <div id="tab-setup" class="tab-pane hidden">
                            <div class="max-w-md mx-auto text-center">
                                <h4 class="text-xl font-bold text-brand-text dark:text-white mb-2">Configurar o Evento Atual</h4>
                                <p class="text-slate-500 dark:text-slate-400 mb-6">Selecione o tipo de evento e a data antes de continuar.</p>
                                <form id="event-setup-form" class="space-y-4">
                                    <div>
                                        <label for="event-type-selector" class="block text-sm font-medium text-slate-700 dark:text-slate-300 text-left">Tipo de Evento</label>
                                        <select id="event-type-selector" class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm">
                                            <option value="Missa">Missa</option>
                                            <option value="Ensaio">Ensaio</option>
                                            <option value="Evento">Evento</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="event-date-selector" class="block text-sm font-medium text-slate-700 dark:text-slate-300 text-left">Data</label>
                                        <input type="date" id="event-date-selector" class="mt-1 block w-full rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm">
                                    </div>
                                    <button type="submit" id="event-setup-form-submit-btn" class="w-full bg-brand-blue text-white font-bold py-3 px-6 rounded-full hover:bg-brand-dark-blue disabled:opacity-50" disabled>
                                        <i class="fas fa-spinner fa-spin mr-2"></i><span>Carregando Membros...</span>
                                    </button>
                                </form>
                                <div id="current-event-display" class="mt-6 p-4 rounded-lg bg-green-50 dark:bg-green-900/50 border border-green-200 dark:border-green-800 text-green-800 dark:text-green-200 hidden"></div>
                            </div>
                        </div>
                        <div id="tab-register" class="tab-pane hidden">
                            <div class="grid-container">
                                <h4 class="text-xl font-bold text-brand-text dark:text-white mb-2">Registrar Presença ou Falta</h4>
                                <p class="text-slate-500 dark:text-slate-400 mb-4">Clique nos botões para registrar o status de cada membro.</p>
                                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4" id="members-grid">
                                    <div class="text-center col-span-full p-8 text-slate-500 dark:text-slate-400">
                                        <i class="fas fa-info-circle mr-2"></i>Por favor, configure um evento.
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="tab-records" class="tab-pane hidden">
                            <div class="table-container h-full flex flex-col">
                                <div class="flex flex-wrap items-center justify-between mb-4 gap-4 flex-shrink-0">
                                    <div class="flex items-center gap-4">
                                        <h4 class="text-xl font-bold text-brand-text dark:text-white">Registros de Presença</h4>
                                        <select id="member-filter-select" class="text-sm rounded-md border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm focus:border-brand-blue focus:ring-brand-blue focus:ring-opacity-50"></select>
                                    </div>
                                    <div class="flex items-center gap-2 flex-wrap">
                                        <button id="export-xlsx-btn" class="bg-green-700 text-white font-semibold py-2 px-4 rounded-full hover:bg-green-800 text-sm">
                                            <i class="fas fa-file-excel mr-2"></i>Exportar XLSX
                                        </button>
                                        <button id="export-pdf-btn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-full hover:bg-red-700 text-sm">
                                            <i class="fas fa-file-pdf mr-2"></i>Exportar PDF
                                        </button>
                                        <button id="open-clear-confirmation-btn" class="bg-red-700 text-white font-semibold py-2 px-4 rounded-full hover:bg-red-800 text-sm">
                                            <i class="fas fa-trash-alt mr-2"></i>Limpar Registros
                                        </button>
                                    </div>
                                </div>
                                <div class="flex-grow overflow-y-auto">
                                    <table class="w-full text-sm text-left text-slate-700 dark:text-slate-300 rota-table">
                                        <thead class="sticky top-0 bg-slate-100 dark:bg-slate-700 z-10">
                                            <tr>
                                                <th>Membro</th><th>Data</th><th>Evento</th><th>Status</th><th>Pontos</th><th>Justificativa</th><th>Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody id="attendance-table-body" class="bg-white dark:bg-slate-800"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="attendance-feedback" class="p-4 bg-white dark:bg-slate-800 border-t dark:border-slate-700 text-center text-sm h-5 font-medium transition-opacity duration-300 opacity-0 flex-shrink-0"></div>
                </div>
            `;

            // 3. APLICA o estado da aba ativa DEPOIS de recarregar o HTML.
            const tabButtonToActivate = container.querySelector(`.attendance-tab-button[data-tab="${activeTabName}"]`);
            const tabPaneToActivate    = container.querySelector(`#tab-${activeTabName}`);

            if (tabButtonToActivate) {
                tabButtonToActivate.classList.add('active');
            } else {
                // fallback para dashboard
                container.querySelector('.attendance-tab-button[data-tab="dashboard"]').classList.add('active');
            }

            if (tabPaneToActivate) {
                // esconde todos os paineis
                container.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));
                // exibe o painel correto
                tabPaneToActivate.classList.remove('hidden');
            }

            // 4. Inicializa eventos e bindings
            initializeAdminFunctionality();
        }

        function renderMemberView(container) {
            const memberData = allMembers.find(m => m.name === currentUser.name);
            const memberRecords = allRecords.filter(r => r.memberId === memberData?.id);
            container.innerHTML = `
                <div id="member-view-container" class="p-6 h-full flex flex-col">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4 flex-shrink-0">
                        <div><h4 class="text-xl font-bold text-brand-text dark:text-white">Meus Registros</h4><p class="text-slate-500 dark:text-slate-400">Bem-vindo(a), ${currentUser.name}.</p></div>
                        <div class="bg-white dark:bg-slate-800 border border-red-200 dark:border-red-800 text-red-800 dark:text-red-300 p-4 rounded-lg text-center shadow-md"><h5 class="text-sm font-semibold uppercase">Total de Pontos de Falta</h5><p class="text-3xl font-bold">${memberData?.totalPoints || 0}</p></div>
                    </div>
                    <div class="table-container flex-grow overflow-y-auto">
                        <table class="w-full text-sm text-left text-slate-700 dark:text-slate-300 rota-table"><thead class="sticky top-0 bg-slate-100 dark:bg-slate-700 z-10"><tr><th>Data</th><th>Evento</th><th>Status</th><th>Pontos</th><th>Justificativa</th></tr></thead><tbody id="member-records-table-body" class="bg-white dark:bg-slate-800"></tbody></table>
                    </div>
                </div>`;
            const tableBody = document.getElementById('member-records-table-body');
            if (memberRecords.length > 0) {
                 tableBody.innerHTML = memberRecords.map(rec => {
                     const statusClass = rec.status === 'Presente' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
                     const dateString = rec.date ? new Date(rec.date + 'T00:00:00').toLocaleDateString('pt-BR', {timeZone: 'UTC'}) : 'Data inválida';
                     return `<tr><td>${dateString}</td><td>${rec.eventType || 'N/A'}</td><td><span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">${rec.status}</span></td><td class="font-bold ${rec.points > 0 ? 'text-red-600' : ''}">${rec.points}</td><td class="text-xs">${rec.justification || '---'}</td></tr>`;
                 }).join('');
            } else { tableBody.innerHTML = '<tr><td colspan="5" class="text-center p-4">Nenhum registro encontrado.</td></tr>'; }
        }
    
        function initializeAdminFunctionality() {
            const container = document.getElementById('attendance-content-area');
            if (!container) return;

            const membersGrid = document.getElementById('members-grid');
            const attendanceTableBody = document.getElementById('attendance-table-body');
            const feedbackEl = document.getElementById('attendance-feedback');
            const memberFilterSelect = document.getElementById('member-filter-select');
            
            function showAttendanceFeedback(message, isError = true, duration = 4000) { if (!feedbackEl) return; feedbackEl.textContent = message; feedbackEl.classList.toggle('text-red-600', isError); feedbackEl.classList.toggle('text-green-600', !isError); feedbackEl.classList.remove('opacity-0'); if (duration > 0) { setTimeout(() => feedbackEl.classList.add('opacity-0'), duration); } }

            function setupDashboard() {
                const totalPresence = allRecords.filter(r => r.status === 'Presente').length;
                const totalAbsence = allRecords.filter(r => r.status === 'Ausente').length;
                const total = totalPresence + totalAbsence;
                const presenceRate = total === 0 ? 0 : Math.round((totalPresence / total) * 100);
                const statPresenceEl = document.getElementById('stat-total-presence');
                if (statPresenceEl) {
                    statPresenceEl.textContent = totalPresence;
                    document.getElementById('stat-total-absence').textContent = totalAbsence;
                    document.getElementById('stat-presence-rate').textContent = `${presenceRate}%`;
                }
                const sortedMembers = [...allMembers].sort((a, b) => (b.totalPoints || 0) - (a.totalPoints || 0));
                const memberRankingBody = document.getElementById('member-ranking-body');
                if(memberRankingBody) { memberRankingBody.innerHTML = sortedMembers.map((member, index) => `<tr><td>${index + 1}º</td><td class="font-semibold">${member.name}</td><td class="font-bold text-red-600">${member.totalPoints || 0}</td></tr>`).join(''); }
            };

            function populateMembersGrid() {
                if (!membersGrid) return;
                membersGrid.innerHTML = '';
                if (!currentEvent || !currentDate) { membersGrid.innerHTML = `<div class="text-center col-span-full p-8 text-slate-500"><i class="fas fa-info-circle mr-2"></i>Configure um evento para começar.</div>`; return; }
                if (allMembers.length === 0) { membersGrid.innerHTML = `<div class="text-center col-span-full p-8 text-slate-500"><i class="fas fa-users mr-2"></i>Nenhum membro encontrado. Carregando...</div>`; return; }
                allMembers.forEach(member => {
                    const card = document.createElement('div');
                    card.className = 'member-card p-4 border rounded-lg shadow-sm bg-white flex flex-col items-center text-center transition-all duration-300';
                    const todaysRecord = allRecords.find(rec => rec.memberId === member.id && rec.date === currentDate && rec.eventType === currentEvent);
                    let presenceBtnClass = "mark-presence-btn flex-1 bg-green-500 text-white font-bold py-2 px-4 rounded-full hover:bg-green-600 transition-all text-sm";
                    let absenceBtnClass = "mark-absence-btn flex-1 bg-orange-500 text-white font-bold py-2 px-4 rounded-full hover:bg-orange-600 transition-all text-sm";
                    let buttonWrapperClass = "mt-4 flex gap-2 attendance-buttons";
                    if (todaysRecord) {
                        buttonWrapperClass += ' selected';
                        if (todaysRecord.status === 'Presente') { presenceBtnClass += ' selected-btn'; } 
                        else if (todaysRecord.status === 'Ausente') { absenceBtnClass += ' selected-btn'; }
                    }
                    card.innerHTML = `<h5 class="text-lg font-bold text-brand-text">${member.name}</h5><p class="text-sm text-slate-500 mb-2">Pontos: <span class="font-bold text-red-600">${member.totalPoints || 0}</span></p><div class="${buttonWrapperClass}"><button data-member-id="${member.id}" class="${presenceBtnClass}"><i class="fas fa-check mr-1"></i> Presente</button><button data-member-id="${member.id}" class="${absenceBtnClass}"><i class="fas fa-times mr-1"></i> Ausente</button></div>`;
                    membersGrid.appendChild(card);
                });
            };

            function populateAttendanceTable(memberId = null) {
                if (!attendanceTableBody) return;
                let filteredRecords = memberId ? allRecords.filter(rec => rec.memberId === memberId) : allRecords;
                
                attendanceTableBody.innerHTML = filteredRecords.map(rec => {
                    const member = allMembers.find(m => m.id === rec.memberId);
                    const statusClass = rec.status === 'Presente' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                    const dateString = rec.date ? new Date(rec.date + 'T00:00:00').toLocaleDateString('pt-BR', {timeZone: 'UTC'}) : 'Data inválida';
                    return `<tr>
                                <td>${member ? member.name : 'Desconhecido'}</td>
                                <td>${dateString}</td><td>${rec.eventType || 'N/A'}</td>
                                <td><span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">${rec.status}</span></td>
                                <td class="font-bold ${rec.points > 0 ? 'text-red-600' : ''}">${rec.points}</td>
                                <td class="text-xs">${rec.justification || '---'}</td>
                                <td class="flex items-center gap-2">
                                    <button data-record-id="${rec.id}" class="edit-record-btn text-brand-blue hover:text-brand-dark-blue text-sm font-semibold">Editar</button>
                                    <button data-record-id="${rec.id}" class="delete-record-btn text-red-500 hover:text-red-700 text-sm font-semibold">Excluir</button>
                                </td>
                            </tr>`;
                }).join('');
            };

            function populateMemberFilter() {
                if (!memberFilterSelect) return;
                const currentVal = memberFilterSelect.value;
                memberFilterSelect.innerHTML = `<option value="all">Todos os Membros</option>`;
                allMembers.forEach(member => {
                    memberFilterSelect.innerHTML += `<option value="${member.id}">${member.name}</option>`;
                });
                memberFilterSelect.value = currentVal;
            };
            
            setupDashboard();
            populateMemberFilter();
            populateAttendanceTable();
            populateMembersGrid();

            const eventSetupForm = document.getElementById('event-setup-form');
            if (eventSetupForm) {
                const submitBtn = document.getElementById('event-setup-form-submit-btn');
                const btnIcon = submitBtn.querySelector('i');
                const btnSpan = submitBtn.querySelector('span');

                if (allMembers.length > 0) {
                    submitBtn.disabled = false;
                    btnIcon.className = 'fas fa-play-circle mr-2';
                    btnSpan.textContent = 'Iniciar Registro';
                }

                const eventDateSelector = document.getElementById('event-date-selector');
                if(eventDateSelector && !eventDateSelector.value) { eventDateSelector.value = new Date().toISOString().split('T')[0]; }

                eventSetupForm.onsubmit = (e) => {
                    e.preventDefault();
                    currentEvent = document.getElementById('event-type-selector').value;
                    currentDate = document.getElementById('event-date-selector').value;
                    if(!currentDate) { showAttendanceFeedback('Por favor, selecione uma data.', true); return; }
                    
                    const currentEventDisplay = document.getElementById('current-event-display');
                    const formattedDate = new Date(currentDate + 'T00:00:00').toLocaleDateString('pt-BR', {timeZone: 'UTC'});
                    currentEventDisplay.innerHTML = `Registro iniciado para: <strong class="font-semibold">${currentEvent}</strong> em <strong class="font-semibold">${formattedDate}</strong>.`;
                    currentEventDisplay.classList.remove('hidden');
                    
                    populateMembersGrid();
                    showAttendanceFeedback('Evento configurado! Pode registar presenças.', false);
                };
            }
            
            if(membersGrid) {
                membersGrid.onclick = (e) => {
                    const presenceBtn = e.target.closest('.mark-presence-btn');
                    const absenceBtn = e.target.closest('.mark-absence-btn');
                    if (presenceBtn) { registerAttendance(presenceBtn.dataset.memberId, 'Presente'); } 
                    else if (absenceBtn) { openJustificationModal(absenceBtn.dataset.memberId); }
                };
            }

            const justificationModal = document.getElementById('justification-modal');
            const confirmJustificationBtn = document.getElementById('confirm-justification-btn');
            function openJustificationModal(memberId) {
                const member = allMembers.find(m => m.id === memberId);
                if (!member || !justificationModal) return;
                justificationModal.querySelector('#justification-title').textContent = `Justificar Ausência: ${member.name}`;
                confirmJustificationBtn.dataset.memberId = member.id;
                justificationModal.querySelector('#justification-text').value = '';
                justificationModal.classList.remove('hidden');
                setTimeout(() => { justificationModal.classList.remove('opacity-0'); justificationModal.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0'); }, 10);
            }
            function closeJustificationModal() {
                if(!justificationModal) return;
                const content = justificationModal.querySelector('.modal-content');
                content.classList.add('scale-95', 'opacity-0');
                justificationModal.classList.add('opacity-0');
                setTimeout(() => justificationModal.classList.add('hidden'), 300);
            }
            document.getElementById('cancel-justification-btn').onclick = closeJustificationModal;
            confirmJustificationBtn.onclick = () => {
                const memberId = confirmJustificationBtn.dataset.memberId;
                const justification = justificationModal.querySelector('#justification-text').value;
                registerAttendance(memberId, 'Ausente', justification);
                closeJustificationModal();
            };

            if(memberFilterSelect) {
                memberFilterSelect.onchange = (e) => {
                    const selectedMemberId = e.target.value;
                    populateAttendanceTable(selectedMemberId === 'all' ? null : selectedMemberId);
                };
            }

            const editRecordModal = document.getElementById('edit-record-modal');
            function openEditModal(recordId) {
                const record = allRecords.find(r => r.id === recordId);
                const member = allMembers.find(m => m.id === record.memberId);
                if(!record || !member || !editRecordModal) return;
                
                editRecordModal.querySelector('#edit-record-id').value = record.id;
                editRecordModal.querySelector('#edit-member-id').value = record.memberId;
                editRecordModal.querySelector('#edit-member-name').textContent = member.name;
                editRecordModal.querySelector('#edit-date').value = record.date;
                editRecordModal.querySelector('#edit-event-type').value = record.eventType;
                editRecordModal.querySelector('#edit-status').value = record.status;
                editRecordModal.querySelector('#edit-justification').value = record.justification || '';

                editRecordModal.classList.remove('hidden');
                setTimeout(() => { editRecordModal.classList.remove('opacity-0'); editRecordModal.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0'); }, 10);
            }
            function closeEditModal() {
                if(!editRecordModal) return;
                const content = editRecordModal.querySelector('.modal-content');
                content.classList.add('scale-95', 'opacity-0');
                editRecordModal.classList.add('opacity-0');
                setTimeout(() => editRecordModal.classList.add('hidden'), 300);
            }
            if (attendanceTableBody) {
                attendanceTableBody.onclick = (e) => { 
                    if(e.target.matches('.edit-record-btn')) { 
                        openEditModal(e.target.dataset.recordId); 
                    } else if (e.target.matches('.delete-record-btn')) {
                        deleteAttendanceRecord(e.target.dataset.recordId);
                    }
                };
            }
            document.getElementById('close-edit-record-modal').onclick = closeEditModal;
            document.getElementById('cancel-edit-btn').onclick = closeEditModal;
            document.getElementById('edit-record-form').onsubmit = (e) => {
                e.preventDefault();
                const form = e.target;
                const recordId = form.querySelector('#edit-record-id').value;
                const memberId = form.querySelector('#edit-member-id').value;
                const updatedData = {
                    date: form.querySelector('#edit-date').value,
                    eventType: form.querySelector('#edit-event-type').value,
                    status: form.querySelector('#edit-status').value,
                    justification: form.querySelector('#edit-justification').value
                };
                updateAttendanceRecord(recordId, memberId, updatedData);
            };

            const exportXLSXBtn = document.getElementById('export-xlsx-btn');
            if (exportXLSXBtn) {
                exportXLSXBtn.addEventListener('click', () => {
                    const selectedMemberId = memberFilterSelect.value;
                    let recordsToExport = allRecords;
                    let memberName = 'Todos';
                    if (selectedMemberId !== 'all') {
                        recordsToExport = allRecords.filter(rec => rec.memberId === selectedMemberId);
                        const member = allMembers.find(m => m.id === selectedMemberId);
                        if (member) memberName = member.name.replace(/\s+/g, '_');
                    }
                    if (recordsToExport.length === 0) { showAttendanceFeedback("Não há registros para exportar.", true); return; }
                    const data = recordsToExport.map(rec => { const member = allMembers.find(m => m.id === rec.memberId); return { 'Membro': member ? member.name : 'Desconhecido', 'Data': new Date(rec.date + 'T00:00:00').toLocaleDateString('pt-BR'), 'Evento': rec.eventType, 'Status': rec.status, 'Pontos': rec.points, 'Justificativa': rec.justification }; });
                    const worksheet = XLSX.utils.json_to_sheet(data);
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, "Presença");
                    XLSX.writeFile(workbook, `Registros_Presenca_Uziel_${memberName}.xlsx`);
                });
            }

            const exportPDFBtn = document.getElementById('export-pdf-btn');
            if (exportPDFBtn) {
                exportPDFBtn.addEventListener('click', () => {
                    const selectedMemberId = memberFilterSelect.value;
                    let recordsToExport = allRecords;
                    let memberName = 'Todos';
                    if (selectedMemberId !== 'all') {
                        recordsToExport = allRecords.filter(rec => rec.memberId === selectedMemberId);
                        const member = allMembers.find(m => m.id === selectedMemberId);
                        if (member) memberName = member.name.replace(/\s+/g, '_');
                    }
                    if (recordsToExport.length === 0) { showAttendanceFeedback("Não há registros para PDF.", true); return; }
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('p', 'pt', 'a4');
                    const tableData = recordsToExport.map(rec => { const member = allMembers.find(m => m.id === rec.memberId); return [ member ? member.name : 'Desconhecido', rec.date ? new Date(rec.date + 'T00:00:00').toLocaleDateString('pt-BR', {timeZone: 'UTC'}) : 'Data inválida', rec.eventType || 'N/A', rec.status, rec.points, rec.justification || '---' ]; });
                    doc.autoTable({ head: [['Membro', 'Data', 'Evento', 'Status', 'Pontos', 'Justificativa']], body: tableData, startY: 60, headStyles: { fillColor: '#29aae2' } });
                    doc.setFontSize(18); doc.setTextColor('#334155'); doc.text('Relatório de Presença e Pontuação', 40, 40);
                    doc.save(`Registros_Uziel_${memberName}.pdf`);
                });
            }
            
            const openClearBtn = document.getElementById('open-clear-confirmation-btn');
            if (openClearBtn) {
                openClearBtn.addEventListener('click', () => {
                    openConfirmationModal(
                        'Tem a certeza que deseja apagar TODOS os registos de presença? Esta ação é irreversível e irá ZERAR as pontuações de todos os membros.',
                        async () => {
                            showAttendanceFeedback("A limpar registos...", false, 0);
                            try {
                                const attendanceSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/attendance`));
                                const batch1 = writeBatch(db);
                                attendanceSnapshot.forEach(doc => batch1.delete(doc.ref));
                                await batch1.commit();
                                const membersSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/members`));
                                const batch2 = writeBatch(db);
                                membersSnapshot.forEach(doc => { batch2.update(doc.ref, { totalPoints: 0 }); });
                                await batch2.commit();
                                logAction('Limpou Históricos de Presença', 'Controle de Presença');
                                showAttendanceFeedback("Todos os registos foram apagados!", false);
                            } catch(error) { console.error("Error clearing records:", error); showAttendanceFeedback("Erro ao limpar registos.", true); } 
                        }
                    );
                });
            }
                                    
            container.querySelector('#attendance-tabs')?.addEventListener('click', (e) => {
                const button = e.target.closest('.attendance-tab-button');
                if (!button) return;
                
                document.querySelectorAll('.attendance-tab-button').forEach(btn => {
                    btn.classList.remove('active', 'bg-brand-blue', 'text-white');
                    btn.classList.add('text-slate-600', 'hover:bg-slate-200');
                });
                button.classList.add('active', 'bg-brand-blue', 'text-white');
                button.classList.remove('text-slate-600', 'hover:bg-slate-200');
                
                document.querySelectorAll('#tab-content-container .tab-pane').forEach(pane => {
                    pane.classList.toggle('hidden', pane.id !== `tab-${button.dataset.tab}`);
                });
            });

            function calculatePoints(eventType, status, justification) {
                if (status === 'Presente') return 0;
                if (justification && justification.trim() !== '') return 0;
                switch (eventType) {
                    case 'Missa': return 5; case 'Ensaio': return 4; case 'Evento': return 10; default: return 0;
                }
            }
            async function registerAttendance(memberId, status, justification = '') {
                if (!currentEvent || !currentDate) { showAttendanceFeedback('Por favor, configure o evento e a data primeiro.', true); return; }
                const member = allMembers.find(m => m.id === memberId);

                if (!member) { showAttendanceFeedback('Membro não encontrado.', true); return; }
                const recordId = `${currentDate}_${currentEvent}_${memberId}`.replace(/\s+/g, '-');
                const recordRef = doc(db, `artifacts/${appId}/public/data/attendance`, recordId);
                const memberRef = doc(db, `artifacts/${appId}/public/data/members`, memberId);
                try {
                    await runTransaction(db, async (transaction) => {
                        const recordDoc = await transaction.get(recordRef);
                        const memberDoc = await transaction.get(memberRef);
                        if (!memberDoc.exists()) { throw "Documento do membro não encontrado!"; }
                        const oldPoints = recordDoc.exists() ? Number(recordDoc.data().points || 0) : 0;
                        const newPoints = calculatePoints(currentEvent, status, justification);
                        const pointDifference = newPoints - oldPoints;
                        transaction.update(memberRef, { totalPoints: increment(pointDifference) });
                        const recordData = { memberId, memberName: member.name, eventType: currentEvent, date: currentDate, status, justification: justification || '', points: newPoints, createdAt: recordDoc.exists() ? recordDoc.data().createdAt : new Date().toISOString() };
                        transaction.set(recordRef, recordData); 
                    });
                    
                    const details = `Definiu ${member.name} como ${status} para ${currentEvent} em ${currentDate}. Justificativa: ${justification || 'nenhuma'}`;
                    logAction('Presença Registrada', 'Controle de Presença', details);
                    
                    showAttendanceFeedback(`Registro de ${member.name} salvo como '${status}'.`, false);
                    
                    if (status === 'Ausente') {
                        triggerWhatsAppNotification(member.name, currentEvent, currentDate, justification);
                    }

                } catch (error) { console.error("Erro na transação de presença: ", error); showAttendanceFeedback("Erro ao salvar.", true); }
            }
            
            async function updateAttendanceRecord(recordId, memberId, updatedData) {
                const recordRef = doc(db, `artifacts/${appId}/public/data/attendance`, recordId);
                const memberRef = doc(db, `artifacts/${appId}/public/data/members`, memberId);
                try {
                    await runTransaction(db, async (transaction) => {
                        const memberDoc = await transaction.get(memberRef);
                        const originalRecordDoc = await transaction.get(recordRef);
                        if (!memberDoc.exists()) { throw "Documento do membro não encontrado!"; }
                        if (!originalRecordDoc.exists()) { throw "Registro original não encontrado na transação!"; }
                        
                        const originalRecord = originalRecordDoc.data();
                        const newRecordId = `${updatedData.date}_${updatedData.eventType}_${memberId}`.replace(/\s+/g, '-');
                        
                        const oldPoints = Number(originalRecord.points || 0);
                        const newPoints = calculatePoints(updatedData.eventType, updatedData.status, updatedData.justification);
                        const pointDifference = newPoints - oldPoints;
                        
                        transaction.update(memberRef, { totalPoints: increment(pointDifference) });
                        if (recordId !== newRecordId) {
                           transaction.delete(recordRef);
                        }
                        const newRecordRef = doc(db, `artifacts/${appId}/public/data/attendance`, newRecordId);
                        const newRecordData = { memberId: originalRecord.memberId, memberName: originalRecord.memberName, createdAt: originalRecord.createdAt, ...updatedData, points: newPoints };
                        transaction.set(newRecordRef, newRecordData);
                    });
                     const details = `Registro atualizado para ${member.name}. Novo status: ${updatedData.status} em ${updatedData.date}`;
                     logAction('Registro de Presença Atualizado', 'Controle de Presença', details);
                     showAttendanceFeedback("Registro atualizado com sucesso!", false);
                     closeEditModal();
                } catch (error) {
                    console.error("Erro ao atualizar registro:", error);
                    showAttendanceFeedback("Falha ao atualizar o registro. Tente novamente.", true);
                }
            }

            async function deleteAttendanceRecord(recordId) {
                if (!currentUser || currentUser.role !== 'admin') return;

                 openConfirmationModal(
                    "Tem certeza que deseja excluir este registro de presença? Os pontos serão revertidos. Esta ação é irreversível.",
                    async () => {
                        const recordRef = doc(db, `artifacts/${appId}/public/data/attendance`, recordId);
                        try {
                            const recordToDelete = allRecords.find(r => r.id === recordId);
                            await runTransaction(db, async (transaction) => {
                                const recordDoc = await transaction.get(recordRef);
                                if (!recordDoc.exists()) { throw "Registro não encontrado."; }

                                const recordData = recordDoc.data();
                                const pointsToReverse = Number(recordData.points || 0);
                                const memberId = recordData.memberId;
                                
                                if (memberId && pointsToReverse !== 0) {
                                    const memberRef = doc(db, `artifacts/${appId}/public/data/members`, memberId);
                                    transaction.update(memberRef, { totalPoints: increment(-pointsToReverse) });
                                }
                                
                                transaction.delete(recordRef);
                            });
                            logAction('Registro de Presença Excluído', 'Controle de Presença', `Registro excluído de ${recordToDelete.memberName} para ${recordToDelete.date}`);
                            showAttendanceFeedback("Registro excluído e pontos revertidos com sucesso.", false);
                        } catch (error) {
                            console.error("Error deleting attendance record:", error);
                            showAttendanceFeedback("Erro ao excluir o registro.", true);
                        }
                    }
                );
            }
        }
        
        // --- AUDIT LOG FUNCTIONS (UPDATED) ---
        function renderAuditLog() {
            const tableBody = document.getElementById('audit-log-table-body');
            const searchInput = document.getElementById('audit-log-search');
            if (!tableBody || !searchInput) return;

            const searchTerm = searchInput.value.toLowerCase();

            // Filter logs based on search term
            const filteredLogs = allAuditLogs.filter(log => {
                if (!searchTerm) return true;
                const timestamp = log.timestamp ? log.timestamp.toDate().toLocaleString('pt-BR') : '';
                // Check all relevant fields for the search term
                return (
                    log.user?.toLowerCase().includes(searchTerm) ||
                    log.module?.toLowerCase().includes(searchTerm) ||
                    log.action?.toLowerCase().includes(searchTerm) ||
                    log.details?.toLowerCase().includes(searchTerm) ||
                    timestamp.toLowerCase().includes(searchTerm)
                );
            });

            if (filteredLogs.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-slate-500">${searchTerm ? 'Nenhum log corresponde à sua pesquisa.' : 'Nenhum log de atividade encontrado.'}</td></tr>`;
                return;
            }

            tableBody.innerHTML = filteredLogs.map(log => {
                const timestamp = log.timestamp ? log.timestamp.toDate().toLocaleString('pt-BR') : 'N/A';
                return `
                    <tr class="hover:bg-slate-100">
                        <td class="whitespace-nowrap">${timestamp}</td>
                        <td>${log.user}</td>
                        <td>${log.module}</td>
                        <td class="font-semibold">${log.action}</td>
                        <td class="text-xs">${log.details || '---'}</td>
                    </tr>
                `;
            }).join('');
        }

        async function clearAuditLog() {
             if (!currentUser || !isSuperAdmin(currentUser)) return;
             
             openConfirmationModal(
                "Tem certeza que deseja apagar TODO o histórico de rastreabilidade? Esta ação é irreversível.",
                async () => {
                     try {
                        const logsCol = collection(db, `artifacts/${appId}/public/data/audit_logs`);
                        const snapshot = await getDocs(logsCol);
                        const batch = writeBatch(db);
                        snapshot.docs.forEach(doc => batch.delete(doc.ref));
                        await batch.commit();
                        await logAction('Limpou Log de Rastreabilidade', 'Rastreabilidade', 'Todos os logs foram excluídos.');
                        // The onSnapshot will automatically clear the table
                    } catch (error) {
                        console.error("Erro ao limpar o log de auditoria:", error);
                        alert("Erro ao limpar o histórico de logs.");
                    }
                }
             );
        }

    </script>
</body>
</html>
